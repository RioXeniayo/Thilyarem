<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Breeding Roller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .container {
            max-width: 1600px;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .card-header {
            font-weight: bold;
            font-size: 1.25rem;
        }
        .chimera-section, .inbreed-details {
            display: none;
            border-left: 3px solid #0d6efd;
            padding-left: 1rem;
            margin-top: 1rem;
        }
        #resultsModal .modal-body {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .form-label {
            font-weight: 500;
        }
        hr {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        h2 {
            text-align: center;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Dragon Breeding Roller üêâ</h2>

    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">Sire</div>
                <div class="card-body" id="sire-form">
                    </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-danger text-white">Dam</div>
                <div class="card-body" id="dam-form">
                    </div>
            </div>
        </div>
    </div>

    <hr>

    <div class="card">
        <div class="card-header">Breeding Settings & Items</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h5>Inbreeding</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="inbred-check">
                        <label class="form-check-label" for="inbred-check">Are the Parents Inbred?</label>
                    </div>
                    <div class="mt-2 inbreed-details">
                        <label for="inbreedingLevel" class="form-label">Inbreeding Level:</label>
                        <select id="inbreedingLevel" class="form-select">
                            <option value="None">None</option>
                            <option value="Slight">Slight</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Severe">Severe</option>
                        </select>
                    </div>
                     <h5 class="mt-3">Bonding</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="bond-breeding-check">
                        <label class="form-check-label" for="bond-breeding-check">Bond Breeding</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <h5>Items</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="fertility-item" id="crescent-herb">
                        <label class="form-check-label" for="crescent-herb">Crescent Herb (Chance at +1 Hatchling)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="fertility-item" id="moonlit-herb">
                        <label class="form-check-label" for="moonlit-herb">Moonlit Herb (Increased mutations, up to +2 cubs)</label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" value="" id="calming-brow">
                        <label class="form-check-label" for="calming-brow">Calming Brow (Increased Destrier chance)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="questionable-potion">
                        <label class="form-check-label" for="questionable-potion">Questionable Potion (Chance for random manetype)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="hearty-meal">
                        <label class="form-check-label" for="hearty-meal">Hearty Meal (Healthier cubs for young/inbred parents)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="dubious-food">
                        <label class="form-check-label" for="dubious-food">Dubious Food (Chance for defects)</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <h5>Companions</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="red-panda-companion">
                        <label class="form-check-label" for="red-panda-companion">Red Panda (2% chance for base color modifiers)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="crane-companion">
                        <label class="form-check-label" for="crane-companion">Crane (2% chance increase of mutations)</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-4">
        <button id="randomize-all-btn" class="btn btn-secondary btn-lg me-2">Randomize Parents</button>
        <button id="roll-btn" class="btn btn-success btn-lg">Roll Breeding!</button>
    </div>

</div> <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultsModalLabel">Breeding Results</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="results-output">
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- DATA DEFINITIONS ---

    const SPECIES = ['Cyroa', 'Thilyarem', 'Destrier'];
    const AGES = ['Hatchling', 'Juvenile', 'Adolescent', 'Young Adult', 'Adult', 'Elder', 'Ancient', 'Celestial'];
    const MANETYPES = ['Natural', 'Razor', 'Sphinx', 'Curly', 'Long', 'Fiery', 'Barbary'];
    const ELEMENTS = ['Fire', 'Water', 'Air', 'Earth', 'Metal', 'Wood', 'Ice', 'Lightning', 'Light', 'Shadow', 'Aether', 'Verdant', 'Unknown'];
    const BASE_COLORS = ['Tan', 'Brown', 'Green', 'White', 'Black', 'Cream', 'Lilac', 'Seagreen', 'Seafoam', 'Slate', 'Blue'];

    const GENOTYPES = {
        'Tan': ["B+/B+ M+/M+ K+/K+", "B+/B+ M+/MB K+/K+", "B+/B+ M+/M0 K+/K+", "B+/B+ MB/MB K+/K+", "B+/B+ MB/M0 K+/K+", "B+/B+ M+/M+ K+/KB", "B+/B+ M+/MB K+/KB", "B+/B+ M+/M0 K+/KB", "B+/B+ MB/MB K+/KB", "B+/B+ MB/M0 K+/KB", "B+/B+ M+/M+ KB/KB", "B+/B+ M+/MB KB/KB", "B+/B+ M+/M0 KB/KB", "B+/B+ MB/MB KB/KB", "B+/B+ MB/M0 KB/KB", "B+/BA M+/M+ K+/K+", "B+/BA M+/MB K+/K+", "B+/BA M+/M0 K+/K+", "B+/BA MB/MB K+/K+", "B+/BA MB/M0 K+/K+", "B+/BA M+/M+ K+/KB", "B+/BA M+/MB K+/KB", "B+/BA M+/M0 K+/KB", "B+/BA MB/MB K+/KB", "B+/BA MB/M0 K+/KB", "B+/BA M+/M+ KB/KB", "B+/BA M+/MB KB/KB", "B+/BA M+/M0 KB/KB", "B+/BA MB/MB KB/KB", "B+/BA MB/M0 KB/KB", "B+/BG M+/M+ K+/K+", "B+/BG M+/MB K+/K+", "B+/BG M+/M0 K+/K+", "B+/BG MB/MB K+/K+", "B+/BG MB/M0 K+/K+", "B+/BG M+/M+ K+/KB", "B+/BG M+/MB K+/KB", "B+/BG M+/M0 K+/KB", "B+/BG MB/MB K+/KB", "B+/BG MB/M0 K+/KB", "B+/BG M+/M+ KB/KB", "B+/BG M+/MB KB/KB", "B+/BG M+/M0 KB/KB", "B+/BG MB/MB KB/KB", "B+/BG MB/M0 KB/KB", "B+/BW M+/M+ K+/K+", "B+/BW M+/MB K+/K+", "B+/BW M+/M0 K+/K+", "B+/BW MB/MB K+/K+", "B+/BW MB/M0 K+/K+", "B+/BW M+/M+ K+/KB", "B+/BW M+/MB K+/KB", "B+/BW M+/M0 K+/KB", "B+/BW MB/MB K+/KB", "B+/BW MB/M0 K+/KB", "B+/BW M+/M+ KB/KB", "B+/BW M+/MB KB/KB", "B+/BW M+/M0 KB/KB", "B+/BW MB/MB KB/KB", "B+/BW MB/M0 KB/KB"],
        'Brown': ["BA/BA M+/M+ K+/K+", "BA/BA M+/MB K+/K+", "BA/BA M+/M0 K+/K+", "BA/BA MB/MB K+/K+", "BA/BA MB/M0 K+/K+", "BA/BA M+/M+ K+/KB", "BA/BA M+/MB K+/KB", "BA/BA M+/M0 K+/KB", "BA/BA MB/MB K+/KB", "BA/BA MB/M0 K+/KB", "BA/BA M+/M+ KB/KB", "BA/BA M+/MB KB/KB", "BA/BA M+/M0 KB/KB", "BA/BA MB/MB KB/KB", "BA/BA MB/M0 KB/KB", "BA/BG M+/M+ K+/K+", "BA/BG M+/MB K+/K+", "BA/BG M+/M0 K+/K+", "BA/BG MB/MB K+/K+", "BA/BG MB/M0 K+/K+", "BA/BG M+/M+ K+/KB", "BA/BG M+/MB K+/KB", "BA/BG M+/M0 K+/KB", "BA/BG MB/MB K+/KB", "BA/BG MB/M0 K+/KB", "BA/BG M+/M+ KB/KB", "BA/BG M+/MB KB/KB", "BA/BG M+/M0 KB/KB", "BA/BG MB/MB KB/KB", "BA/BG MB/M0 KB/KB", "BA/BW M+/M+ K+/K+", "BA/BW M+/MB K+/K+", "BA/BW M+/M0 K+/K+", "BA/BW MB/MB K+/K+", "BA/BW MB/M0 K+/K+", "BA/BW M+/M+ K+/KB", "BA/BW M+/MB K+/KB", "BA/BW M+/M0 K+/KB", "BA/BW MB/MB K+/KB", "BA/BW MB/M0 K+/KB", "BA/BW M+/M+ KB/KB", "BA/BW M+/MB KB/KB", "BA/BW M+/M0 KB/KB", "BA/BW MB/MB KB/KB", "BA/BW MB/M0 KB/KB"],
        'Green': ["BG/BG M+/M+ K+/K+", "BG/BG M+/MB K+/K+", "BG/BG M+/M0 K+/K+", "BG/BG MB/M0 K+/K+", "BG/BG M+/M+ K+/KB", "BG/BG M+/MB K+/KB", "BG/BG M+/M0 K+/KB", "BG/BG MB/M0 K+/KB", "BG/BG M+/M+ KB/KB", "BG/BG M+/MB KB/KB", "BG/BG M+/M0 KB/KB", "BG/BG MB/M0 KB/KB", "BG/BW M+/M+ K+/K+", "BG/BW M+/MB K+/K+", "BG/BW M+/M0 K+/K+", "BG/BW MB/M0 K+/K+", "BG/BW M+/M+ K+/KB", "BG/BW M+/MB K+/KB", "BG/BW M+/M0 K+/KB", "BG/BW MB/M0 K+/KB", "BG/BW M+/M+ KB/KB", "BG/BW M+/MB KB/KB", "BG/BW M+/M0 KB/KB", "BG/BW MB/M0 KB/KB"],
        'White': ["BW/BW M0/M0 K+/K+", "BW/BW M0/M0 K+/KB", "BW/BW M0/M0 KB/KB"],
        'Black': ["B+/B+ M+/M+ KB/KB", "B+/BA M+/M+ KB/KB", "B+/BG M+/M+ KB/KB", "B+/BW M+/M+ KB/KB", "BA/BA M+/M+ KB/KB", "BA/BG M+/M+ KB/KB", "BA/BW M+/M+ KB/KB", "BG/BG M+/M+ KB/KB", "BG/BW M+/M+ KB/KB", "BW/BW M+/M+ KB/KB"],
        'Cream': ["B+/B+ M0/M0 K+/K+", "B+/B+ M0/M0 K+/KB", "B+/B+ M0/M0 KB/KB", "B+/BA M0/M0 K+/K+", "B+/BA M0/M0 K+/KB", "B+/BA M0/M0 KB/KB", "B+/BG M0/M0 K+/K+", "B+/BG M0/M0 K+/KB", "B+/BG M0/M0 KB/KB", "B+/BW M0/M0 K+/K+", "B+/BW M0/M0 K+/KB", "B+/BW M0/M0 KB/KB"],
        'Lilac': ["BA/BA M0/M0 K+/K+", "BA/BA M0/M0 K+/KB", "BA/BA M0/M0 KB/KB", "BA/BG M0/M0 K+/K+", "BA/BG M0/M0 K+/KB", "BA/BG M0/M0 KB/KB", "BA/BW M0/M0 K+/K+", "BA/BW M0/M0 K+/KB", "BA/BW M0/M0 KB/KB"],
        'Seagreen': ["BG/BG MB/MB K+/K+", "BG/BG MB/MB K+/KB", "BG/BG MB/MB KB/KB", "BG/BW MB/MB K+/K+", "BG/BW MB/MB K+/KB", "BG/BW MB/MB KB/KB"],
        'Seafoam': ["BG/BG M0/M0 K+/K+", "BG/BG M0/M0 K+/KB", "BG/BG M0/M0 KB/KB", "BG/BW M0/M0 K+/K+", "BG/BW M0/M0 K+/KB", "BG/BW M0/M0 KB/KB"],
        'Slate': ["BW/BW M+/M+ K+/K+", "BW/BW M+/MB K+/K+", "BW/BW M+/M0 K+/K+", "BW/BW MB/M0 K+/K+", "BW/BW M+/M+ K+/KB", "BW/BW M+/MB K+/KB", "BW/BW M+/M0 K+/KB", "BW/BW MB/M0 K+/KB", "BW/BW M+/M+ KB/KB", "BW/BW M+/MB KB/KB", "BW/BW M+/M0 KB/KB", "BW/BW MB/M0 KB/KB"],
        'Blue': ["BW/BW MB/MB K+/K+", "BW/BW MB/MB K+/KB", "BW/BW MB/MB KB/KB"],
    };
    
    const PHENO_ALLELES = { R: 'Vermillion', J: 'Jade', C: 'Amber', P: 'Pearl'};

    const GENE_LIBRARY = {
        Markings: {
            Dpl: { name: 'Dapples', rarity: 'Common' }, Bt: { name: 'Bellytone', rarity: 'Common' }, Mtl: { name: 'Mantle', rarity: 'Common' }, Clr: { name: 'Collar', rarity: 'Common' }, Ikd: { name: 'Inked', rarity: 'Common' }, Sia: { name: 'Siamese', rarity: 'Common' }, Pnt: { name: 'Points', rarity: 'Common' }, Stn: { name: 'Stained', rarity: 'Common' }, Rn: { name: 'Roan', rarity: 'Common' }, Tby: { name: 'Tabby', rarity: 'Common' }, Spt: { name: 'Spotted', rarity: 'Common' }, Apl: { name: 'Appalosa', rarity: 'Uncommon' }, Mrl: { name: 'Merle', rarity: 'Uncommon' }, Brn: { name: 'Barring', rarity: 'Uncommon' }, Dn: { name: 'Dun', rarity: 'Uncommon' }, Pyn: { name: 'Python', rarity: 'Uncommon' }, Stk: { name: 'Streaks', rarity: 'Uncommon' }, Ovr: { name: 'Overo', rarity: 'Uncommon' }, Rsc: { name: 'Rorscach', rarity: 'Uncommon' }, Pg: { name: 'Pangare', rarity: 'Uncommon' }, Sb: { name: 'Sable', rarity: 'Uncommon' }, Pb: { name: 'Piebald', rarity: 'Rare' }, Gnt: { name: 'Glint', rarity: 'Rare' }, Sf: { name: 'Snowfall', rarity: 'Rare' }, Wd: { name: 'Widow', rarity: 'Rare' }, Dmd: { name: 'Diamond', rarity: 'Rare' }, Spr: { name: 'Spider', rarity: 'Rare' }, Gln: { name: 'Glint', rarity: 'Rare' }, Stm: { name: 'Spectrum', rarity: 'Rare' }, Iri: { name: 'Iridescent', rarity: 'Rare' }
        },
        Mutations: {
            Vit: { name: 'Vitiligo', rarity: 'Common' }, Inv: { name: 'Inversa', rarity: 'Uncommon' }, Les: { name: 'Leucistic', rarity: 'Uncommon' }, Alb: { name: 'Albino', rarity: 'Uncommon' }, Axg: { name: 'Axanthic -G', rarity: 'Uncommon' }, Ery: { name: 'Erythristic', rarity: 'Rare' }, Lva: { name: 'Lavender Albino', rarity: 'Rare' }, Axm: { name: 'Axanthic-M', rarity: 'Rare' }
        },
        Traits: { // These are the inheritable abilities
            Unbent: { name: 'Unbent', rarity: 'Common'}, Cunning: { name: 'Cunning', rarity: 'Common'}, Strike: { name: 'Strike', rarity: 'Common'}, Bold: { name: 'Bold', rarity: 'Common'}, Swift: { name: 'Swift', rarity: 'Common'}, Skillful_Hunter: { name: 'Skillful Hunter', rarity: 'Common'}, Completionist: { name: 'Completionist', rarity: 'Common'}, Ocean_Champion: { name: 'Ocean Champion', rarity: 'Common'}, Fish_Wrangler: { name: 'Fish Wrangler', rarity: 'Common'}, Charismatic: { name: 'Charismatic', rarity: 'Common'}, Shaman: { name: 'Shaman', rarity: 'Common'}, Foraging_Maestro: { name: 'Foraging Maestro', rarity: 'Common'}
        }
    };
    
    // --- UTILITY FUNCTIONS ---
    
    const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const roll = (chance) => Math.random() < chance;

    /** Creates the HTML for a parent form */
    function createParentForm(prefix) {
        const abilities = Object.values(GENE_LIBRARY.Traits).map(t => t.name);
        return `
            <div class="mb-3">
                <label for="${prefix}-species" class="form-label">Species:</label>
                <select id="${prefix}-species" class="form-select">${SPECIES.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
            </div>
            <div class="mb-3">
                <label for="${prefix}-age" class="form-label">Age:</label>
                <select id="${prefix}-age" class="form-select">${AGES.map(a => `<option value="${a}">${a}</option>`).join('')}</select>
            </div>
            <div class="mb-3">
                <label for="${prefix}-manetype" class="form-label">Manetype:</label>
                <select id="${prefix}-manetype" class="form-select">${MANETYPES.map(m => `<option value="${m}">${m}</option>`).join('')}</select>
            </div>
            <hr>
            <h5>Genetics</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="${prefix}-base-color" class="form-label">Base Color (Phenotype):</label>
                    <select id="${prefix}-base-color" class="form-select base-color-selector" data-prefix="${prefix}">
                        ${BASE_COLORS.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="${prefix}-base-genetics" class="form-label">Base Genetics (Genotype):</label>
                    <select id="${prefix}-base-genetics" class="form-select"></select>
                </div>
            </div>
            <div class="mb-3">
                <label for="${prefix}-marking-genetics" class="form-label">Marking/Mutation/Trait Genetics:</label>
                <textarea id="${prefix}-marking-genetics" class="form-control" rows="3" placeholder="Enter alleles like Dpl/Dpl, nVit, nUnbent..."></textarea>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input chimera-check" type="checkbox" id="${prefix}-chimera-check" data-prefix="${prefix}">
                <label class="form-check-label" for="${prefix}-chimera-check">Chimerism</label>
            </div>
            <div class="chimera-section" id="${prefix}-chimera-section">
                <h6>Chimera Genetics</h6>
                 <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="${prefix}-chimera-base-color" class="form-label">Base Color (Phenotype):</label>
                        <select id="${prefix}-chimera-base-color" class="form-select base-color-selector" data-prefix="${prefix}-chimera">
                            ${BASE_COLORS.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="${prefix}-chimera-base-genetics" class="form-label">Base Genetics (Genotype):</label>
                        <select id="${prefix}-chimera-base-genetics" class="form-select"></select>
                    </div>
                </div>
                 <div class="mb-3">
                    <label for="${prefix}-chimera-marking-genetics" class="form-label">Marking/Mutation/Trait Genetics:</label>
                    <textarea id="${prefix}-chimera-marking-genetics" class="form-control" rows="3" placeholder="Enter alleles for chimera side..."></textarea>
                </div>
            </div>
            <hr>
            <h5>Abilities & Element</h5>
             <div class="mb-3">
                <label for="${prefix}-element" class="form-label">Inborn Element:</label>
                <select id="${prefix}-element" class="form-select">${ELEMENTS.slice(0,-1).map(e => `<option value="${e}">${e}</option>`).join('')}</select>
            </div>
            <div class="mb-3">
                <label class="form-label">Inheritable Abilities (Traits):</label>
                <div class="row">
                ${abilities.map(ability => `
                    <div class="col-6 col-sm-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${ability.replace(/ /g, '_')}" id="${prefix}-trait-${ability.replace(/ /g, '_')}">
                            <label class="form-check-label" for="${prefix}-trait-${ability.replace(/ /g, '_')}">${ability}</label>
                        </div>
                    </div>
                `).join('')}
                </div>
            </div>
             <div class="mb-3">
                <label class="form-label">Celestial Abilities:</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${prefix}-divine-blessing">
                    <label class="form-check-label" for="${prefix}-divine-blessing">Divine Blessing</label>
                </div>
                 <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${prefix}-savage-boon">
                    <label class="form-check-label" for="${prefix}-savage-boon">Savage Boon</label>
                </div>
                 <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${prefix}-prismatic-aura">
                    <label class="form-check-label" for="${prefix}-prismatic-aura">Prismatic Aura</label>
                </div>
            </div>
        `;
    }

    /** Populates the base genetics dropdown based on the selected color */
    function updateBaseGenetics(prefix) {
        const color = document.getElementById(`${prefix}-base-color`).value;
        const geneticsDropdown = document.getElementById(`${prefix}-base-genetics`);
        const options = GENOTYPES[color] || [];
        geneticsDropdown.innerHTML = options.map(g => `<option value="${g}">${g}</option>`).join('');
    }
    
    /** Parses a genetics string (e.g., "nVit Dpl/dpl") into an array of alleles */
    function parseAlleleString(str) {
        const alleles = [];
        const parts = str.trim().split(/[\s,]+/);
        parts.forEach(part => {
            if (!part) return;
            if (part.includes('/')) {
                // It's a pair like Dpl/dpl
                const [a1, a2] = part.split('/');
                alleles.push(a1, a2);
            } else if (part.startsWith('n')) {
                // It's a het like nVit
                alleles.push('n', part.substring(1));
            } else {
                 // It's a homozygous like VitVit
                 const match = part.match(/([A-Z][a-z_]*)([A-Z][a-z_]*)/);
                 if (match) {
                     alleles.push(match[1], match[2]);
                 } else { // Fallback for single allele
                     alleles.push(part, part);
                 }
            }
        });
        return alleles;
    }
    
    /** Performs a punnett square for two parent alleles */
    function inheritAllele(parent1Alleles, parent2Alleles) {
        const allele1 = getRandom(parent1Alleles);
        const allele2 = getRandom(parent2Alleles);
        return [allele1, allele2].sort().join('/'); // Always store sorted for consistency
    }

    /** Randomizes a single parent's form */
    function randomizeParent(prefix) {
        // Simple random selections
        document.getElementById(`${prefix}-species`).value = getRandom(SPECIES);
        document.getElementById(`${prefix}-age`).value = getRandom(AGES);
        document.getElementById(`${prefix}-manetype`).value = getRandom(MANETYPES);
        document.getElementById(`${prefix}-element`).value = getRandom(ELEMENTS.slice(0, -1));

        // Random base genetics
        const randomColor = getRandom(BASE_COLORS);
        document.getElementById(`${prefix}-base-color`).value = randomColor;
        updateBaseGenetics(prefix);
        const geneticsDropdown = document.getElementById(`${prefix}-base-genetics`);
        if (geneticsDropdown.options.length > 0) {
            geneticsDropdown.selectedIndex = Math.floor(Math.random() * geneticsDropdown.options.length);
        }

        // Random markings, mutations, traits
        let randomGenes = '';
        const allGenes = {...GENE_LIBRARY.Markings, ...GENE_LIBRARY.Mutations, ...GENE_LIBRARY.Traits};
        const geneKeys = Object.keys(allGenes);
        for (let i = 0; i < 5; i++) { // Add ~5 random genes
            const key = getRandom(geneKeys);
            if (roll(0.5)) { // 50% chance of being het
                 randomGenes += `n${key} `;
            } else {
                 randomGenes += `${key}/${key} `;
            }
        }
        document.getElementById(`${prefix}-marking-genetics`).value = randomGenes.trim();
        
        // Randomize checkboxes (low chance)
        document.getElementById(`${prefix}-chimera-check`).checked = false; // Keep this off by default
        document.querySelector(`#${prefix}-chimera-section`).style.display = 'none';

        Object.keys(GENE_LIBRARY.Traits).forEach(traitKey => {
            document.getElementById(`${prefix}-trait-${traitKey}`).checked = roll(0.2);
        });
        document.getElementById(`${prefix}-divine-blessing`).checked = roll(0.1);
        document.getElementById(`${prefix}-savage-boon`).checked = roll(0.1);
        document.getElementById(`${prefix}-prismatic-aura`).checked = roll(0.1);
    }
    
    // --- MAIN BREEDING LOGIC ---

    function rollBreeding() {
        // 1. Gather Inputs
        const sire = getParentData('sire');
        const dam = getParentData('dam');
        const settings = getSettings();
        
        let output = '';

        // 2. Validate Age
        if (['Hatchling', 'Juvenile'].includes(sire.age) || ['Hatchling', 'Juvenile'].includes(dam.age)) {
            output = 'Error: One or both dragons are too young to breed.';
            showResults(output);
            return;
        }

        // 3. Determine Cub Count
        let minCubs = 1, maxCubs = 5;
        if (sire.age === 'Adolescent' || dam.age === 'Adolescent') { minCubs = 0; maxCubs = 2; }
        else if (sire.age === 'Young Adult' || dam.age === 'Young Adult') { minCubs = 1; maxCubs = 3; }
        else if (sire.age === 'Adult' || dam.age === 'Adult') { minCubs = 1; maxCubs = 5; }
        else if (sire.age === 'Elder' || dam.age === 'Elder') { minCubs = 2; maxCubs = 4; }
        else if (sire.age === 'Ancient' || dam.age === 'Ancient') { minCubs = 2; maxCubs = 3; }
        else if (sire.age === 'Celestial' || dam.age === 'Celestial') { minCubs = 2; maxCubs = 2; }
        
        let cubCount = Math.floor(Math.random() * (maxCubs - minCubs + 1)) + minCubs;

        // Item modifiers for cub count
        if (settings.crescentHerb && roll(0.5)) cubCount++; // Assuming 50% chance for crescent herb
        if (settings.moonlitHerb) cubCount += Math.floor(Math.random() * 3); // 0, 1, or 2 additional
        if (settings.bondBreeding) cubCount++;
        
        if (cubCount === 0) {
            output = "The breeding resulted in no viable hatchlings.";
            showResults(output);
            return;
        }

        // 4. Loop for each cub
        for (let i = 1; i <= cubCount; i++) {
            output += `================ HATCHLING #${i} ================\n`;
            
            // Very rare chance for Chimerism
            if (roll(0.01)) { // 1% chance for random chimerism
                const part1 = generateCub(sire, dam, settings);
                const part2 = generateCub(sire, dam, settings);
                output += `Species: ${part1.species.name} // ${part2.species.name}\n`;
                output += `Build: ${part1.species.build} // ${part2.species.build}\n`;
                output += `Sex: ${part1.sex}\n`;
                output += `Manetype: ${part1.manetype} // ${part2.manetype}\n`;
                output += `Element: ${part1.element} // ${part2.element}\n`;
                output += `Base Color: ${part1.baseColor} // ${part2.baseColor}\n`;
                output += `Genotype: ${part1.genotype} // ${part2.genotype}\n`;
                output += `Phenotype: ${part1.phenotype} // ${part2.phenotype}\n`;
                output += `Mutations: ${part1.mutations} // ${part2.mutations}\n`;
                output += `Traits: ${part1.traits}\n`; // Traits are shared
                output += `Fertility: ${part1.fertility} // ${part2.fertility}\n`;
                output += `Inbred: ${part1.inbred}\n`;
                output += `Defects: Chimerism, ${[...new Set([...part1.defects, ...part2.defects])].join(', ') || 'Healthy'}\n`;
            } else {
                 const cub = generateCub(sire, dam, settings);
                 output += `Species: ${cub.species.name}\n`;
                 output += `Build: ${cub.species.build}\n`;
                 output += `Sex: ${cub.sex}\n`;
                 output += `Manetype: ${cub.manetype}\n`;
                 output += `Element: ${cub.element}\n`;
                 output += `Base Color: ${cub.baseColor}\n`;
                 output += `Genotype: ${cub.genotype}\n`;
                 output += `Phenotype: ${cub.phenotype}\n`;
                 output += `Mutations: ${cub.mutations}\n`;
                 output += `Traits: ${cub.traits}\n`;
                 output += `Fertility: ${cub.fertility}\n`;
                 output += `Inbred: ${cub.inbred}\n`;
                 output += `Defects: ${cub.defects.join(', ') || 'Healthy'}\n`;
            }
            output += '\n';
        }

        showResults(output);
    }
    
    /** Generates a single cub's genetics */
    function generateCub(sire, dam, settings) {
        // If a parent is chimera, randomly select which geno to pass
        const sireGeno = sire.isChimera && roll(0.5) ? sire.chimera : sire.primary;
        const damGeno = dam.isChimera && roll(0.5) ? dam.primary : dam.primary;
        
        const cub = {};
        cub.sex = roll(0.5) ? 'Male' : 'Female';
        cub.species = determineSpecies(sire, dam, settings);
        cub.manetype = determineManetype(sire.manetype, dam.manetype, settings);
        cub.element = roll(0.5) ? sire.element : dam.element;
        
        // Base Genetics
        const baseAlleles = {};
        ['B', 'M', 'K'].forEach(locus => {
            const sireL = sireGeno.baseGenetics.split(' ')['BMK'.indexOf(locus)].split('/');
            const damL = damGeno.baseGenetics.split(' ')['BMK'.indexOf(locus)].split('/');
            baseAlleles[locus] = inheritAllele(sireL, damL).split('/');
        });
        cub.genotype = `${baseAlleles.B.join('/')} ${baseAlleles.M.join('/')} ${baseAlleles.K.join('/')}`;
        cub.baseColor = determinePhenoColor(cub.genotype);
        
        // Markings, Mutations, Traits
        const inherited = { Markings: [], Mutations: [], Traits: []};
        const pheno = { Markings: [], Mutations: [], Traits: [] };
        
        Object.keys(GENE_LIBRARY).forEach(category => {
            const allAlleles = {...sireGeno[category.toLowerCase()], ...damGeno[category.toLowerCase()]};
            Object.keys(allAlleles).forEach(allele => {
                const sireA = sireGeno[category.toLowerCase()][allele] || ['n', 'n'];
                const damA = damGeno[category.toLowerCase()][allele] || ['n', 'n'];
                const childAlleles = inheritAllele(sireA, damA).split('/');
                
                if (childAlleles[0] !== 'n' || childAlleles[1] !== 'n') {
                    const info = GENE_LIBRARY[category][allele];
                    if (childAlleles[0] === 'n') {
                        inherited[category].push(`n${allele}`);
                    } else {
                        inherited[category].push(`${childAlleles.join('')}`);
                        pheno[category].push(info.name);
                    }
                }
            });
        });
        
        cub.genotype += ` ${inherited.Markings.join(' ')} ${inherited.Mutations.join(' ')} ${inherited.Traits.join(' ')}`.trim();
        cub.phenotype = pheno.Markings.join(', ') || 'None';
        cub.mutations = pheno.Mutations.join(', ') || 'None';
        cub.traits = pheno.Traits.join(', ') || 'None';
        
        cub.defects = [];
        cub.inbred = settings.isInbred ? 'Yes' : 'No';
        cub.fertility = "Fertile";
        
        // TODO: Implement defect logic based on settings.inbreedLevel and items
        
        return cub;
    }
    
    function determinePhenoColor(geno) {
        for (const color in GENOTYPES) {
            if (GENOTYPES[color].includes(geno)) {
                return color;
            }
        }
        return "Unknown";
    }

    function determineSpecies(sire, dam, settings) {
        let destrierChance = 0.1; // Base chance if one parent is destrier
        if (sire.species === 'Destrier' && dam.species === 'Destrier') destrierChance = 0.75;
        else if (sire.species === 'Destrier' || dam.species === 'Destrier') destrierChance = 0.5;

        if (settings.calmingBrow) destrierChance += 0.1;
        if (sire.savageBoon || dam.savageBoon) destrierChance += 0.05;

        if (roll(destrierChance)) return { name: 'Panlongus Lykophus Imperator', build: 'Destrier' };
        
        const pool = [];
        if (sire.species !== 'Destrier') pool.push(sire.species);
        if (dam.species !== 'Destrier') pool.push(dam.species);
        
        const build = pool.length > 0 ? getRandom(pool) : (roll(0.5) ? 'Cyroa' : 'Thilyarem'); // Fallback
        if (build === 'Cyroa') return { name: 'Panlongus murepera scirto', build: 'Cyroa' };
        if (build === 'Thilyarem') return { name: 'Panlongus lykophus pelagius', build: 'Thilyarem' };
        
        // Fallback should not be reached often
        return { name: 'Panlongus lykophus pelagius', build: 'Thilyarem' };
    }
    
    function determineManetype(sireMane, damMane, settings) {
        // Simplified mane logic for brevity. A full implementation would require a large probability matrix.
        const pool = [sireMane, damMane];
        const rareManes = ['Sphinx', 'Curly', 'Long', 'Fiery', 'Barbary'];
        let passChance = 0.5; // Base chance for a specific mane to pass
        
        // Bond breeding bonus
        if (settings.bondBreeding && (rareManes.includes(sireMane) || rareManes.includes(damMane))) {
            passChance += 0.02;
        }
        // Divine Blessing bonus
        if (settings.sire.divineBlessing || settings.dam.divineBlessing) {
            passChance += 0.05;
        }

        if (sireMane === damMane) {
            // If parents match, very high chance to pass it on
            return roll(0.9) ? sireMane : getRandom(MANETYPES);
        }
        
        if (roll(passChance)) {
            return getRandom(pool);
        } else {
            // If it doesn't pass, Natural is most common, with a small chance for something else.
            return roll(0.7) ? 'Natural' : getRandom(MANETYPES);
        }
    }

    /** Gathers all data from a parent's form */
    function getParentData(prefix) {
        const data = {
            primary: {},
            isChimera: document.getElementById(`${prefix}-chimera-check`).checked,
            chimera: {}
        };

        const traits = {};
        Object.keys(GENE_LIBRARY.Traits).forEach(key => {
            if(document.getElementById(`${prefix}-trait-${key}`).checked) {
                traits[key] = [key, key]; // Assume homozygous for simplicity
            }
        });
        
        const markings = {};
        const mutations = {};
        const geneticsStr = document.getElementById(`${prefix}-marking-genetics`).value;
        const parsedAlleles = parseAlleleString(geneticsStr);
        for(let i=0; i < parsedAlleles.length; i+=2) {
            const allele = parsedAlleles[i+1];
            if(GENE_LIBRARY.Markings[allele]) markings[allele] = [parsedAlleles[i], parsedAlleles[i+1]];
            if(GENE_LIBRARY.Mutations[allele]) mutations[allele] = [parsedAlleles[i], parsedAlleles[i+1]];
            // Traits from text box override checkboxes
            if(GENE_LIBRARY.Traits[allele]) traits[allele] = [parsedAlleles[i], parsedAlleles[i+1]];
        }
        
        data.species = document.getElementById(`${prefix}-species`).value;
        data.age = document.getElementById(`${prefix}-age`).value;
        data.manetype = document.getElementById(`${prefix}-manetype`).value;
        data.element = document.getElementById(`${prefix}-element`).value;
        data.divineBlessing = document.getElementById(`${prefix}-divine-blessing`).checked;
        data.savageBoon = document.getElementById(`${prefix}-savage-boon`).checked;
        data.prismaticAura = document.getElementById(`${prefix}-prismatic-aura`).checked;

        data.primary.baseGenetics = document.getElementById(`${prefix}-base-genetics`).value;
        data.primary.markings = markings;
        data.primary.mutations = mutations;
        data.primary.traits = traits;

        if (data.isChimera) {
             // Simplified Chimera data gathering
            data.chimera.baseGenetics = document.getElementById(`${prefix}-chimera-base-genetics`).value;
            data.chimera.markings = {}; // Assume empty for now
            data.chimera.mutations = {};
            data.chimera.traits = {};
        }

        return data;
    }

    /** Gathers all global breeding settings */
    function getSettings() {
        return {
            isInbred: document.getElementById('inbred-check').checked,
            inbreedLevel: document.getElementById('inbreedingLevel').value,
            crescentHerb: document.getElementById('crescent-herb').checked,
            moonlitHerb: document.getElementById('moonlit-herb').checked,
            calmingBrow: document.getElementById('calming-brow').checked,
            questionablePotion: document.getElementById('questionable-potion').checked,
            heartyMeal: document.getElementById('hearty-meal').checked,
            dubiousFood: document.getElementById('dubious-food').checked,
            bondBreeding: document.getElementById('bond-breeding-check').checked,
            redPanda: document.getElementById('red-panda-companion').checked,
            crane: document.getElementById('crane-companion').checked,
            sire: { // Pulling just ability flags for easier access
                divineBlessing: document.getElementById('sire-divine-blessing').checked,
                savageBoon: document.getElementById('sire-savage-boon').checked
            },
            dam: {
                divineBlessing: document.getElementById('dam-divine-blessing').checked,
                savageBoon: document.getElementById('dam-savage-boon').checked
            }
        };
    }
    
    /** Displays the final results in the modal */
    function showResults(outputText) {
        document.getElementById('results-output').textContent = outputText;
        const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
        resultsModal.show();
    }
    
    // --- INITIALIZATION AND EVENT LISTENERS ---

    function init() {
        // Create parent forms
        document.getElementById('sire-form').innerHTML = createParentForm('sire');
        document.getElementById('dam-form').innerHTML = createParentForm('dam');
        
        // Initial randomization
        randomizeParent('sire');
        randomizeParent('dam');
        
        // Setup event listeners
        document.getElementById('roll-btn').addEventListener('click', rollBreeding);
        document.getElementById('randomize-all-btn').addEventListener('click', () => {
            randomizeParent('sire');
            randomizeParent('dam');
        });
        
        document.querySelectorAll('.base-color-selector').forEach(sel => {
            sel.addEventListener('change', (e) => updateBaseGenetics(e.target.dataset.prefix));
            // Trigger initial population
            updateBaseGenetics(sel.dataset.prefix);
        });

        document.querySelectorAll('.chimera-check').forEach(chk => {
            chk.addEventListener('change', (e) => {
                const prefix = e.target.dataset.prefix;
                const section = document.getElementById(`${prefix}-chimera-section`);
                section.style.display = e.target.checked ? 'block' : 'none';
                if (e.target.checked) {
                    updateBaseGenetics(`${prefix}-chimera`);
                }
            });
        });
        
        document.getElementById('inbred-check').addEventListener('change', (e) => {
            document.querySelector('.inbreed-details').style.display = e.target.checked ? 'block' : 'none';
        });

    }

    init(); // Run the app
});
</script>

</body>
</html>
