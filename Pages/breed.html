<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breeding Roller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1100px; }
        .form-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .results-section { margin-top: 20px; }
        .form-control, .form-select { margin-bottom: 15px; }
        .error-message { color: red; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Breeding Roller</h1>
        <div class="form-section">
            <h3>Parent A</h3>
            <div class="row">
                <div class="col-md-6">
                    <label for="parentA-species">Species:</label>
                    <select id="parentA-species" class="form-select">
                        <option value="Thilyarem">Thilyarem</option>
                        <option value="Destrier">Destrier</option>
                        <option value="Cyroas">Cyroas</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="parentA-age">Age:</label>
                    <select id="parentA-age" class="form-select">
                        <option value="Hatchling">Hatchling</option>
                        <option value="Juvenile">Juvenile</option>
                        <option value="Adolescent">Adolescent</option>
                        <option value="Young Adult" selected>Young Adult</option>
                        <option value="Adult">Adult</option>
                        <option value="Elder">Elder</option>
                        <option value="Ancient">Ancient</option>
                        <option value="Celestial">Celestial</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="parentA-mane">Mane:</label>
                    <select id="parentA-mane" class="form-select">
                        <option value="Natural" selected>Natural</option>
                        <option value="Razor">Razor</option>
                        <option value="Curly">Curly</option>
                        <option value="Sphinx">Sphinx</option>
                        <option value="Long">Long</option>
                        <option value="Fiery">Fiery</option>
                        <option value="Barbary">Barbary</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="parentA-element">Element:</label>
                    <select id="parentA-element" class="form-select">
                        <option value="Fire" selected>Fire</option>
                        <option value="Water">Water</option>
                        <option value="Air">Air</option>
                        <option value="Earth">Earth</option>
                        <option value="Metal">Metal</option>
                        <option value="Wood">Wood</option>
                        <option value="Ice">Ice</option>
                        <option value="Lightning">Lightning</option>
                        <option value="Light">Light</option>
                        <option value="Shadow">Shadow</option>
                        <option value="Aether">Aether</option>
                        <option value="Verdant">Verdant</option>
                    </select>
                </div>
            </div>
            <label for="parentA-genotype">Genotype:</label>
            <input type="text" id="parentA-genotype" class="form-control" placeholder="e.g., B+/BA M+/M+ K+/KB Spt Mrl/Mrl">

            <h3 class="mt-4">Parent B</h3>
            <div class="row">
                <div class="col-md-6">
                    <label for="parentB-species">Species:</label>
                    <select id="parentB-species" class="form-select">
                        <option value="Thilyarem">Thilyarem</option>
                        <option value="Destrier">Destrier</option>
                        <option value="Cyroas">Cyroas</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="parentB-age">Age:</label>
                    <select id="parentB-age" class="form-select">
                        <option value="Hatchling">Hatchling</option>
                        <option value="Juvenile">Juvenile</option>
                        <option value="Adolescent">Adolescent</option>
                        <option value="Young Adult" selected>Young Adult</option>
                        <option value="Adult">Adult</option>
                        <option value="Elder">Elder</option>
                        <option value="Ancient">Ancient</option>
                        <option value="Celestial">Celestial</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="parentB-mane">Mane:</label>
                    <select id="parentB-mane" class="form-select">
                        <option value="Natural" selected>Natural</option>
                        <option value="Razor">Razor</option>
                        <option value="Curly">Curly</option>
                        <option value="Sphinx">Sphinx</option>
                        <option value="Long">Long</option>
                        <option value="Fiery">Fiery</option>
                        <option value="Barbary">Barbary</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="parentB-element">Element:</label>
                    <select id="parentB-element" class="form-select">
                        <option value="Fire" selected>Fire</option>
                        <option value="Water">Water</option>
                        <option value="Air">Air</option>
                        <option value="Earth">Earth</option>
                        <option value="Metal">Metal</option>
                        <option value="Wood">Wood</option>
                        <option value="Ice">Ice</option>
                        <option value="Lightning">Lightning</option>
                        <option value="Light">Light</option>
                        <option value="Shadow">Shadow</option>
                        <option value="Aether">Aether</option>
                        <option value="Verdant">Verdant</option>
                    </select>
                </div>
            </div>
            <label for="parentB-genotype">Genotype:</label>
            <input type="text" id="parentB-genotype" class="form-control" placeholder="e.g., B+/BA M+/M+ K+/KB Spt Mrl/Mrl">

            <h3 class="mt-4">Breeding Items</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check">
                        <input type="checkbox" id="crescent-herb" class="form-check-input">
                        <label for="crescent-herb" class="form-check-label">Crescent Herb</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="moonlit-herb" class="form-check-input">
                        <label for="moonlit-herb" class="form-check-label">Moonlit Herb</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="celestial-perk">Celestial Perk:</label>
                    <select id="celestial-perk" class="form-select">
                        <option value="None">None</option>
                        <option value="Savage Boon">Savage Boon</option>
                        <option value="Divine Blessing">Divine Blessing</option>
                        <option value="Prismatic Aura">Prismatic Aura</option>
                    </select>
                </div>
            </div>

            <label for="coi">Coefficient of Inbreeding:</label>
            <select id="coi" class="form-select">
                <option value="None">None</option>
                <option value="Slight">Slight</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
            </select>

            <button id="calculate-btn" class="btn btn-primary mt-3">Calculate Breeding</button>
            <div id="error-message" class="error-message mt-2"></div>
        </div>

        <div id="results" class="results-section"></div>
    </div>

    <script>
        // Configuration constants
        const CONFIG = {
            UI: {
                DIALOG_WIDTH: 1100,
                DIALOG_HEIGHT: 800,
                MENU_NAME: 'Breeding Roller',
                HTML_FILE: 'breedroller'
            },
            BREEDING: {
                DEFAULT_CLUTCH: '1 - 3 eggs',
                DEFAULT_MANE: 'Natural',
                DEFAULT_ELEMENT: 'Fire'
            },
            LOGGING: {
                ENABLED: true,
                PREFIX: '[BreedingRoller]'
            }
        };

        // Simple logger replacement for browser
        const Logger = {
            log: (message) => {
                if (CONFIG.LOGGING.ENABLED) {
                    console.log(message);
                }
            }
        };

        // Error Handler
        class ErrorHandler {
            static handle(error, context, ui = null) {
                const message = `${CONFIG.LOGGING.PREFIX} Error in ${context}: ${error.message}\nStack: ${error.stack}`;
                if (CONFIG.LOGGING.ENABLED) Logger.log(message);
                if (ui) {
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('error-message').innerText = `Error in ${context}: Please check input or try again.`;
                }
                return message;
            }
        }

        // Enums and Data
        const Sex = { MALE: 'Male', FEMALE: 'Female' };
        const Breed = { THIL: 'Thilyarem', DEST: 'Destrier', CYROA: 'Cyroas' };
        const ScientificNames = {
            [Breed.THIL]: 'Panlongus lykophus pelagius',
            [Breed.DEST]: 'Panlongus lykophus imperator',
            [Breed.CYROA]: 'Panlongus murepera scirto'
        };
        const Age = { 
            HATCHLING: 'Hatchling', 
            JUVENILE: 'Juvenile', 
            ADOLESCENT: 'Adolescent', 
            YOUNG_ADULT: 'Young Adult', 
            ADULT: 'Adult', 
            ELDER: 'Elder', 
            ANCIENT: 'Ancient', 
            CELESTIAL: 'Celestial' 
        };
        const Element = { 
            FIRE: 'Fire', 
            WATER: 'Water', 
            AIR: 'Air', 
            EARTH: 'Earth', 
            METAL: 'Metal', 
            WOOD: 'Wood', 
            ICE: 'Ice', 
            LIGHTNING: 'Lightning', 
            LIGHT: 'Light', 
            SHADOW: 'Shadow', 
            AETHER: 'Aether', 
            VERDANT: 'Verdant' 
        };
        const GeneType = { 
            BASE: 0, 
            MARKING: 1, 
            MUTATION: 2, 
            MANE: 3, 
            TRAIT: 4, 
            MODIFIER: 5 
        };
        const Defects = {
            Common: ['Deafness', 'Blindness', 'Anosmia'],
            Uncommon: ['Slug Egg', 'Lameness', 'Hip Dysplasia', 'Anosmia'],
            Rare: ['Infertile', 'Malformed Tail', 'Malformed Limbs', 'Heart Disease'],
            VeryRare: ['Stillborn', 'Underdeveloped', 'Spinal Defect', 'Epilepsy']
        };

        const AgePerks = {
            [Age.HATCHLING]: { breedable: false, clutch_min: 0, clutch_max: 0, trait_pass_bonus: 0, mutation_bonus: 0, rare_marking_bonus: 0 },
            [Age.JUVENILE]: { breedable: false, clutch_min: 0, clutch_max: 0, trait_pass_bonus: 0, mutation_bonus: 0, rare_marking_bonus: 0 },
            [Age.ADOLESCENT]: { breedable: true, clutch_min: 0, clutch_max: 2, trait_pass_bonus: 0, mutation_bonus: 0, rare_marking_bonus: 0 },
            [Age.YOUNG_ADULT]: { breedable: true, clutch_min: 1, clutch_max: 3, trait_pass_bonus: 0, mutation_bonus: 0, rare_marking_bonus: 0 },
            [Age.ADULT]: { breedable: true, clutch_min: 1, clutch_max: 5, trait_pass_bonus: 0, mutation_bonus: 0, rare_marking_bonus: 0 },
            [Age.ELDER]: { breedable: true, clutch_min: 2, clutch_max: 4, trait_pass_bonus: 5, mutation_bonus: 10, rare_marking_bonus: 0 },
            [Age.ANCIENT]: { breedable: true, clutch_min: 2, clutch_max: 3, trait_pass_bonus: 10, mutation_bonus: 15, rare_marking_bonus: 5 },
            [Age.CELESTIAL]: { breedable: true, clutch_min: 2, clutch_max: 2, trait_pass_bonus: 15, mutation_bonus: 20, rare_marking_bonus: 10 }
        };

        const BreedMix = {
            [`${Breed.THIL}_${Breed.THIL}`]: { [Breed.THIL]: 100 },
            [`${Breed.THIL}_${Breed.DEST}`]: { [Breed.THIL]: 95, [Breed.DEST]: 5 },
            [`${Breed.DEST}_${Breed.THIL}`]: { [Breed.DEST]: 15, [Breed.THIL]: 85 },
            [`${Breed.DEST}_${Breed.DEST}`]: { [Breed.THIL]: 65, [Breed.DEST]: 35 },
            [`${Breed.CYROA}_${Breed.CYROA}`]: { [Breed.CYROA]: 100 },
            [`${Breed.THIL}_${Breed.CYROA}`]: { [Breed.THIL]: 50, [Breed.CYROA]: 50 },
            [`${Breed.CYROA}_${Breed.THIL}`]: { [Breed.CYROA]: 50, [Breed.THIL]: 50 },
            [`${Breed.CYROA}_${Breed.DEST}`]: { [Breed.CYROA]: 95, [Breed.DEST]: 5 }
        };

        const GeneMap = {
            TAN: { TEXT: 'Tan', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['B+/B+', 'M+/M+', 'K+/K+'], ['B+/B+', 'M+/M+', 'K+/KB'], ['B+/B+', 'M+/MB', 'K+/K+'], ['B+/B+', 'M+/MB', 'K+/KB'], 
                ['B+/B+', 'M+/M0', 'K+/K+'], ['B+/B+', 'M+/M0', 'K+/KB'], ['B+/B+', 'MB/MB', 'K+/K+'], ['B+/B+', 'MB/MB', 'K+/KB'], 
                ['B+/B+', 'MB/M0', 'K+/K+'], ['B+/B+', 'MB/M0', 'K+/KB'], ['B+/BA', 'M+/M+', 'K+/K+'], ['B+/BA', 'M+/M+', 'K+/KB'], 
                ['B+/BA', 'M+/MB', 'K+/K+'], ['B+/BA', 'M+/MB', 'K+/KB'], ['B+/BA', 'M+/M0', 'K+/K+'], ['B+/BA', 'M+/M0', 'K+/KB'], 
                ['B+/BA', 'MB/MB', 'K+/K+'], ['B+/BA', 'MB/MB', 'K+/KB'], ['B+/BA', 'MB/M0', 'K+/K+'], ['B+/BA', 'MB/M0', 'K+/KB'], 
                ['B+/BG', 'M+/M+', 'K+/K+'], ['B+/BG', 'M+/M+', 'K+/KB'], ['B+/BG', 'M+/MB', 'K+/K+'], ['B+/BG', 'M+/MB', 'K+/KB'], 
                ['B+/BG', 'M+/M0', 'K+/K+'], ['B+/BG', 'M+/M0', 'K+/KB'], ['B+/BG', 'MB/MB', 'K+/K+'], ['B+/BG', 'MB/MB', 'K+/KB'], 
                ['B+/BG', 'MB/M0', 'K+/K+'], ['B+/BG', 'MB/M0', 'K+/KB'], ['B+/BW', 'M+/M+', 'K+/K+'], ['B+/BW', 'M+/M+', 'K+/KB'], 
                ['B+/BW', 'M+/MB', 'K+/K+'], ['B+/BW', 'M+/MB', 'K+/KB'], ['B+/BW', 'M+/M0', 'K+/K+'], ['B+/BW', 'M+/M0', 'K+/KB'], 
                ['B+/BW', 'MB/MB', 'K+/K+'], ['B+/BW', 'MB/MB', 'K+/KB'], ['B+/BW', 'MB/M0', 'K+/K+'], ['B+/BW', 'MB/M0', 'K+/KB']
            ]},
            CREAM: { TEXT: 'Cream', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['B+/B+', 'M0/M0', 'K+/K+'], ['B+/B+', 'M0/M0', 'K+/KB'], ['B+/BA', 'M0/M0', 'K+/K+'], ['B+/BA', 'M0/M0', 'K+/KB'], 
                ['B+/BG', 'M0/M0', 'K+/K+'], ['B+/BG', 'M0/M0', 'K+/KB'], ['B+/BW', 'M0/M0', 'K+/K+'], ['B+/BW', 'M0/M0', 'K+/KB']
            ]},
            BROWN: { TEXT: 'Brown', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['BA/BA', 'M+/M+', 'K+/K+'], ['BA/BA', 'M+/M+', 'K+/KB'], ['BA/BA', 'M+/MB', 'K+/K+'], ['BA/BA', 'M+/MB', 'K+/KB'], 
                ['BA/BA', 'M+/M0', 'K+/K+'], ['BA/BA', 'M+/M0', 'K+/KB'], ['BA/BA', 'MB/MB', 'K+/K+'], ['BA/BA', 'MB/MB', 'K+/KB'], 
                ['BA/BA', 'MB/M0', 'K+/K+'], ['BA/BA', 'MB/M0', 'K+/KB'], ['BA/BG', 'M+/M+', 'K+/K+'], ['BA/BG', 'M+/M+', 'K+/KB'], 
                ['BA/BG', 'M+/MB', 'K+/K+'], ['BA/BG', 'M+/MB', 'K+/KB'], ['BA/BG', 'M+/M0', 'K+/K+'], ['BA/BG', 'M+/M0', 'K+/KB'], 
                ['BA/BG', 'MB/MB', 'K+/K+'], ['BA/BG', 'MB/MB', 'K+/KB'], ['BA/BG', 'MB/M0', 'K+/K+'], ['BA/BG', 'MB/M0', 'K+/KB'], 
                ['BA/BW', 'M+/M+', 'K+/K+'], ['BA/BW', 'M+/M+', 'K+/KB'], ['BA/BW', 'M+/MB', 'K+/K+'], ['BA/BW', 'M+/MB', 'K+/KB'], 
                ['BA/BW', 'M+/M0', 'K+/K+'], ['BA/BW', 'M+/M0', 'K+/KB'], ['BA/BW', 'MB/MB', 'K+/K+'], ['BA/BW', 'MB/MB', 'K+/KB'], 
                ['BA/BW', 'MB/M0', 'K+/K+'], ['BA/BW', 'MB/M0', 'K+/KB']
            ]},
            LILAC: { TEXT: 'Lilac', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['BA/BA', 'M0/M0', 'K+/K+'], ['BA/BA', 'M0/M0', 'K+/KB'], ['BA/BG', 'M0/M0', 'K+/K+'], ['BA/BG', 'M0/M0', 'K+/KB'], 
                ['BA/BW', 'M0/M0', 'K+/K+'], ['BA/BW', 'M0/M0', 'K+/KB']
            ]},
            GREEN: { TEXT: 'Green', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['BG/BG', 'M+/M+', 'K+/K+'], ['BG/BG', 'M+/M+', 'K+/KB'], ['BG/BG', 'M+/MB', 'K+/K+'], ['BG/BG', 'M+/MB', 'K+/KB'], 
                ['BG/BG', 'M+/M0', 'K+/K+'], ['BG/BG', 'M+/M0', 'K+/KB'], ['BG/BG', 'MB/M0', 'K+/K+'], ['BG/BG', 'MB/M0', 'K+/KB'], 
                ['BG/BW', 'M+/M+', 'K+/K+'], ['BG/BW', 'M+/M+', 'K+/KB'], ['BG/BW', 'M+/MB', 'K+/K+'], ['BG/BW', 'M+/MB', 'K+/KB'], 
                ['BG/BW', 'M+/M0', 'K+/K+'], ['BG/BW', 'M+/M0', 'K+/KB'], ['BG/BW', 'MB/M0', 'K+/K+'], ['BG/BW', 'MB/M0', 'K+/KB']
            ]},
            SEAGREEN: { TEXT: 'Seagreen', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['BG/BG', 'MB/MB', 'K+/K+'], ['BG/BG', 'MB/MB', 'K+/KB'], ['BG/BW', 'MB/MB', 'K+/K+'], ['BG/BW', 'MB/MB', 'K+/KB']
            ]},
            SEAFOAM: { TEXT: 'Seafoam', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['BG/BG', 'M0/M0', 'K+/K+'], ['BG/BG', 'M0/M0', 'K+/KB'], ['BG/BW', 'M0/M0', 'K+/K+'], ['BG/BW', 'M0/M0', 'K+/KB']
            ]},
            SLATE: { TEXT: 'Slate', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['BW/BW', 'M+/M+', 'K+/K+'], ['BW/BW', 'M+/M+', 'K+/KB'], ['BW/BW', 'M+/MB', 'K+/K+'], ['BW/BW', 'M+/MB', 'K+/KB'], 
                ['BW/BW', 'M+/M0', 'K+/K+'], ['BW/BW', 'M+/M0', 'K+/KB'], ['BW/BW', 'MB/M0', 'K+/K+'], ['BW/BW', 'MB/M0', 'K+/KB']
            ]},
            BLUE: { TEXT: 'Blue', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['BW/BW', 'MB/MB', 'K+/K+'], ['BW/BW', 'MB/MB', 'K+/KB']
            ]},
            WHITE: { TEXT: 'White', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['BW/BW', 'M0/M0', 'K+/K+'], ['BW/BW', 'M0/M0', 'K+/KB']
            ]},
            BLACK: { TEXT: 'Black', TYPE: GeneType.BASE, EXPRESSED_SETS: [
                ['B+/B+', 'M+/M+', 'KB/KB'], ['B+/B+', 'M+/MB', 'KB/KB'], ['B+/B+', 'M+/M0', 'KB/KB'], ['B+/B+', 'MB/MB', 'KB/KB'], 
                ['B+/B+', 'MB/M0', 'KB/KB'], ['B+/BA', 'M+/M+', 'KB/KB'], ['B+/BA', 'M+/MB', 'KB/KB'], ['B+/BA', 'M+/M0', 'KB/KB'], 
                ['B+/BA', 'MB/MB', 'KB/KB'], ['B+/BA', 'MB/M0', 'KB/KB'], ['B+/BG', 'M+/M+', 'KB/KB'], ['B+/BG', 'M+/MB', 'KB/KB'], 
                ['B+/BG', 'M+/M0', 'KB/KB'], ['B+/BG', 'MB/MB', 'KB/KB'], ['B+/BG', 'MB/M0', 'KB/KB'], ['B+/BW', 'M+/M+', 'KB/KB'], 
                ['B+/BW', 'M+/MB', 'KB/KB'], ['B+/BW', 'M+/M0', 'KB/KB'], ['B+/BW', 'MB/MB', 'KB/KB'], ['B+/BW', 'MB/M0', 'KB/KB'], 
                ['BA/BA', 'M+/M+', 'KB/KB'], ['BA/BG', 'M+/M+', 'KB/KB'], ['BA/BW', 'M+/M+', 'KB/KB'], 
                ['BG/BG', 'M+/M+', 'KB/KB'], ['BG/BW', 'M+/M+', 'KB/KB'], ['BW/BW', 'M+/M+', 'KB/KB']
            ]},
            VERMILLION: { TEXT: 'Vermillion', TYPE: GeneType.MODIFIER, EXPRESSED_SETS: [['R/R']], CARRIED_SETS: [['R/n']] },
            JADE: { TEXT: 'Jade', TYPE: GeneType.MODIFIER, EXPRESSED_SETS: [['J/J']], CARRIED_SETS: [['J/n']] },
            AMBER: { TEXT: 'Amber', TYPE: GeneType.MODIFIER, EXPRESSED_SETS: [['C/C']], CARRIED_SETS: [['C/n']] },
            PEARL: { TEXT: 'Pearl', TYPE: GeneType.MODIFIER, EXPRESSED_SETS: [['P/P']], CARRIED_SETS: [['P/n']] },
            DAPPLES: { TEXT: 'Dapples', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Dpl/Dpl'], ['Dpl/n']] },
            BELLYTONE: { TEXT: 'Bellytone', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Bt/Bt'], ['Bt/n']] },
            MANTLE: { TEXT: 'Mantle', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Mtl/Mtl'], ['Mtl/n']] },
            COLLAR: { TEXT: 'Collar', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Clr/Clr'], ['Clr/n']] },
            INKED: { TEXT: 'Inked', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Ikd/Ikd'], ['Ikd/n']] },
            SIAMESE: { TEXT: 'Siamese', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Sia/Sia'], ['Sia/n']] },
            POINTS: { TEXT: 'Points', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Pnt/Pnt'], ['Pnt/n']] },
            STAINED: { TEXT: 'Stained', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Stn/Stn'], ['Stn/n']] },
            ROAN: { TEXT: 'Roan', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Rn/Rn'], ['Rn/n']] },
            TABBY: { TEXT: 'Tabby', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Tby/Tby'], ['Tby/n']] },
            SPOTTED: { TEXT: 'Spotted', TYPE: GeneType.MARKING, RARITY: 'common', EXPRESSED_SETS: [['Spt/Spt'], ['Spt/n']] },
            APPALOOSA: { TEXT: 'Appaloosa', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Apl/Apl'], ['Apl/n']] },
            MERLE: { TEXT: 'Merle', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Mrl/Mrl'], ['Mrl/n']] },
            BARRING: { TEXT: 'Barring', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Brn/Brn'], ['Brn/n']] },
            DUN: { TEXT: 'Dun', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Dn/Dn'], ['Dn/n']] },
            PYTHON: { TEXT: 'Python', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Pyn/Pyn'], ['Pyn/n']] },
            STREAKS: { TEXT: 'Streaks', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Stk/Stk'], ['Stk/n']] },
            OVERO: { TEXT: 'Overo', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Ovr/Ovr'], ['Ovr/n']] },
            RORSCHACH: { TEXT: 'Rorschach', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Rsc/Rsc'], ['Rsc/n']] },
            PANGARE: { TEXT: 'Pangare', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Pg/Pg'], ['Pg/n']] },
            SABLE: { TEXT: 'Sable', TYPE: GeneType.MARKING, RARITY: 'uncommon', EXPRESSED_SETS: [['Sb/Sb'], ['Sb/n']] },
            PIEBALD: { TEXT: 'Piebald', TYPE: GeneType.MARKING, RARITY: 'rare', EXPRESSED_SETS: [['Pb/Pb'], ['Pb/n']] },
            GLINT: { TEXT: 'Glint', TYPE: GeneType.MARKING, RARITY: 'rare', EXPRESSED_SETS: [['Gln/Gln'], ['Gln/n']] },
            SNOWFALL: { TEXT: 'Snowfall', TYPE: GeneType.MARKING, RARITY: 'rare', EXPRESSED_SETS: [['Sf/Sf'], ['Sf/n']] },
            WIDOW: { TEXT: 'Widow', TYPE: GeneType.MARKING, RARITY: 'rare', EXPRESSED_SETS: [['Wd/Wd'], ['Wd/n']] },
            DIAMOND: { TEXT: 'Diamond', TYPE: GeneType.MARKING, RARITY: 'rare', EXPRESSED_SETS: [['Dmd/Dmd'], ['Dmd/n']] },
            SPIDER: { TEXT: 'Spider', TYPE: GeneType.MARKING, RARITY: 'rare', EXPRESSED_SETS: [['Spr/Spr'], ['Spr/n']] },
            SPECTRUM: { TEXT: 'Spectrum', TYPE: GeneType.MARKING, RARITY: 'rare', EXPRESSED_SETS: [['Stm/Stm'], ['Stm/n']] },
            IRIDESCENT: { TEXT: 'Iridescent', TYPE: GeneType.MARKING, RARITY: 'rare', EXPRESSED_SETS: [['Iri/Iri'], ['Iri/n']] },
            VITILIGO: { TEXT: 'Vitiligo', TYPE: GeneType.MUTATION, RARITY: 'common', EXPRESSED_SETS: [['Vit/Vit'], ['Vit/n']] },
            INVERSA: { TEXT: 'Inversa', TYPE: GeneType.MUTATION, RARITY: 'uncommon', EXPRESSED_SETS: [['Inv/Inv'], ['Inv/n']] },
            LEUCISTIC: { TEXT: 'Leucistic', TYPE: GeneType.MUTATION, RARITY: 'uncommon', EXPRESSED_SETS: [['Les/Les'], ['Les/n']] },
            ALBINO: { TEXT: 'Albino', TYPE: GeneType.MUTATION, RARITY: 'uncommon', EXPRESSED_SETS: [['Alb/Alb'], ['Alb/n']] },
            AXANTHIC_G: { TEXT: 'Axanthic-G', TYPE: GeneType.MUTATION, RARITY: 'uncommon', EXPRESSED_SETS: [['Axg/Axg'], ['Axg/n']] },
            ERYTHRISTIC: { TEXT: 'Erythristic', TYPE: GeneType.MUTATION, RARITY: 'rare', EXPRESSED_SETS: [['Ery/Ery'], ['Ery/n']] },
            LAVENDER_ALBINO: { TEXT: 'Lavender Albino', TYPE: GeneType.MUTATION, RARITY: 'rare', EXPRESSED_SETS: [['Lva/Lva'], ['Lva/n']] },
            AXANTHIC_M: { TEXT: 'Axanthic-M', TYPE: GeneType.MUTATION, RARITY: 'rare', EXPRESSED_SETS: [['Axm/Axm'], ['Axm/n']] },
            CHIMERISM: { TEXT: 'Chimerism', TYPE: GeneType.MUTATION, RARITY: 'very rare', EXPRESSED_SETS: [['Cm/Cm'], ['Cm/n']] },
            NATURAL: { TEXT: 'Natural', TYPE: GeneType.MANE, RARITY: 'common' },
            RAZOR: { TEXT: 'Razor', TYPE: GeneType.MANE, RARITY: 'uncommon' },
            CURLY: { TEXT: 'Curly', TYPE: GeneType.MANE, RARITY: 'uncommon' },
            SPHINX: { TEXT: 'Sphinx', TYPE: GeneType.MANE, RARITY: 'rare' },
            LONG: { TEXT: 'Long', TYPE: GeneType.MANE, RARITY: 'rare' },
            FIERY: { TEXT: 'Fiery', TYPE: GeneType.MANE, RARITY: 'rare' },
            BARBARY: { TEXT: 'Barbary', TYPE: GeneType.MANE, RARITY: 'rare' },
            HORNED: { TEXT: 'Horned', TYPE: GeneType.TRAIT, RARITY: 'uncommon', EXPRESSED_SETS: [['Hr/Hr'], ['Hr/n']] },
            FANGED: { TEXT: 'Fanged', TYPE: GeneType.TRAIT, RARITY: 'uncommon', EXPRESSED_SETS: [['Fg/Fg'], ['Fg/n']] },
            SABRETEETH: { TEXT: 'Sabreteeth', TYPE: GeneType.TRAIT, RARITY: 'rare', EXPRESSED_SETS: [['St/St'], ['St/n']] }
        };

        const OverrideRules = [
            { result: 'Painted', requires: ['Pb/Pb', 'Wd/Wd'], removes: ['Piebald', 'Widow'] }
        ];

        const loci = [
            { locus: 'B', category: 'base', null_allele: 'n', genes: [
                { allele: 'B+', homozygous_genotype: 'B+/B+', heterozygous_genotypes: ['B+/BA', 'B+/BG', 'B+/BW'] },
                { allele: 'BA', homozygous_genotype: 'BA/BA', heterozygous_genotypes: ['BA/BG', 'BA/BW'] },
                { allele: 'BG', homozygous_genotype: 'BG/BG', heterozygous_genotypes: ['BG/BW'] },
                { allele: 'BW', homozygous_genotype: 'BW/BW', heterozygous_genotypes: [] }
            ]},
            { locus: 'M', category: 'base', null_allele: 'n', genes: [
                { allele: 'M+', homozygous_genotype: 'M+/M+', heterozygous_genotypes: ['M+/MB', 'M+/M0'] },
                { allele: 'MB', homozygous_genotype: 'MB/MB', heterozygous_genotypes: ['MB/M0'] },
                { allele: 'M0', homozygous_genotype: 'M0/M0', heterozygous_genotypes: [] }
            ]},
            { locus: 'K', category: 'base', null_allele: 'n', genes: [
                { allele: 'K+', homozygous_genotype: 'K+/K+', heterozygous_genotypes: ['K+/KB'] },
                { allele: 'KB', homozygous_genotype: 'KB/KB', heterozygous_genotypes: [] }
            ]},
            { locus: 'R', category: 'modifier', null_allele: 'n', genes: [{ allele: 'R', homozygous_genotype: 'R/R', heterozygous_genotypes: ['R/n'] }] },
            { locus: 'J', category: 'modifier', null_allele: 'n', genes: [{ allele: 'J', homozygous_genotype: 'J/J', heterozygous_genotypes: ['J/n'] }] },
            { locus: 'C', category: 'modifier', null_allele: 'n', genes: [{ allele: 'C', homozygous_genotype: 'C/C', heterozygous_genotypes: ['C/n'] }] },
            { locus: 'P', category: 'modifier', null_allele: 'n', genes: [{ allele: 'P', homozygous_genotype: 'P/P', heterozygous_genotypes: ['P/n'] }] },
            { locus: 'Dpl', category: 'marking', null_allele: 'n', genes: [{ allele: 'Dpl', homozygous_genotype: 'Dpl/Dpl', heterozygous_genotypes: ['Dpl/n'] }] },
            { locus: 'Bt', category: 'marking', null_allele: 'n', genes: [{ allele: 'Bt', homozygous_genotype: 'Bt/Bt', heterozygous_genotypes: ['Bt/n'] }] },
            { locus: 'Mtl', category: 'marking', null_allele: 'n', genes: [{ allele: 'Mtl', homozygous_genotype: 'Mtl/Mtl', heterozygous_genotypes: ['Mtl/n'] }] },
            { locus: 'Clr', category: 'marking', null_allele: 'n', genes: [{ allele: 'Clr', homozygous_genotype: 'Clr/Clr', heterozygous_genotypes: ['Clr/n'] }] },
            { locus: 'Ikd', category: 'marking', null_allele: 'n', genes: [{ allele: 'Ikd', homozygous_genotype: 'Ikd/Ikd', heterozygous_genotypes: ['Ikd/n'] }] },
            { locus: 'Sia', category: 'marking', null_allele: 'n', genes: [{ allele: 'Sia', homozygous_genotype: 'Sia/Sia', heterozygous_genotypes: ['Sia/n'] }] },
            { locus: 'Pnt', category: 'marking', null_allele: 'n', genes: [{ allele: 'Pnt', homozygous_genotype: 'Pnt/Pnt', heterozygous_genotypes: ['Pnt/n'] }] },
            { locus: 'Stn', category: 'marking', null_allele: 'n', genes: [{ allele: 'Stn', homozygous_genotype: 'Stn/Stn', heterozygous_genotypes: ['Stn/n'] }] },
            { locus: 'Rn', category: 'marking', null_allele: 'n', genes: [{ allele: 'Rn', homozygous_genotype: 'Rn/Rn', heterozygous_genotypes: ['Rn/n'] }] },
            { locus: 'Tby', category: 'marking', null_allele: 'n', genes: [{ allele: 'Tby', homozygous_genotype: 'Tby/Tby', heterozygous_genotypes: ['Tby/n'] }] },
            { locus: 'Spt', category: 'marking', null_allele: 'n', genes: [{ allele: 'Spt', homozygous_genotype: 'Spt/Spt', heterozygous_genotypes: ['Spt/n'] }] },
            { locus: 'Apl', category: 'marking', null_allele: 'n', genes: [{ allele: 'Apl', homozygous_genotype: 'Apl/Apl', heterozygous_genotypes: ['Apl/n'] }] },
            { locus: 'Mrl', category: 'marking', null_allele: 'n', genes: [{ allele: 'Mrl', homozygous_genotype: 'Mrl/Mrl', heterozygous_genotypes: ['Mrl/n'] }] },
            { locus: 'Brn', category: 'marking', null_allele: 'n', genes: [{ allele: 'Brn', homozygous_genotype: 'Brn/Brn', heterozygous_genotypes: ['Brn/n'] }] },
            { locus: 'Dn', category: 'marking', null_allele: 'n', genes: [{ allele: 'Dn', homozygous_genotype: 'Dn/Dn', heterozygous_genotypes: ['Dn/n'] }] },
            { locus: 'Pyn', category: 'marking', null_allele: 'n', genes: [{ allele: 'Pyn', homozygous_genotype: 'Pyn/Pyn', heterozygous_genotypes: ['Pyn/n'] }] },
            { locus: 'Stk', category: 'marking', null_allele: 'n', genes: [{ allele: 'Stk', homozygous_genotype: 'Stk/Stk', heterozygous_genotypes: ['Stk/n'] ]] },
            { locus: 'Ovr', category: 'marking', null_allele: 'n', genes: [{ allele: 'Ovr', homozygous_genotype: 'Ovr/Ovr', heterozygous_genotypes: ['Ovr/n'] }] },
            { locus: 'Rsc', category: 'marking', null_allele: 'n', genes: [{ allele: 'Rsc', homozygous_genotype: 'Rsc/Rsc', heterozygous_genotypes: ['Rsc/n'] }] },
            { locus: 'Pg', category: 'marking', null_allele: 'n', genes: [{ allele: 'Pg', homozygous_genotype: 'Pg/Pg', heterozygous_genotypes: ['Pg/n'] }] },
            { locus: 'Sb', category: 'marking', null_allele: 'n', genes: [{ allele: 'Sb', homozygous_genotype: 'Sb/Sb', heterozygous_genotypes: ['Sb/n'] ]] },
            { locus: 'Pb', category: 'marking', null_allele: 'n', genes: [{ allele: 'Pb', homozygous_genotype: 'Pb/Pb', heterozygous_genotypes: ['Pb/n'] ]] },
            { locus: 'Gln', category: 'marking', null_allele: 'n', genes: [{ allele: 'Gln', homozygous_genotype: 'Gln/Gln', heterozygous_genotypes: ['Gln/n'] ]] },
            { locus: 'Sf', category: 'marking', null_allele: 'n', genes: [{ allele: 'Sf', homozygous_genotype: 'Sf/Sf', heterozygous_genotypes: ['Sf/n'] ]] },
            { locus: 'Wd', category: 'marking', null_allele: 'n', genes: [{ allele: 'Wd', homozygous_genotype: 'Wd/Wd', heterozygous_genotypes: ['Wd/n'] ]] },
            { locus: 'Dmd', category: 'marking', null_allele: 'n', genes: [{ allele: 'Dmd', homozygous_genotype: 'Dmd/Dmd', heterozygous_genotypes: ['Dmd/n'] ]] },
            { locus: 'Spr', category: 'marking', null_allele: 'n', genes: [{ allele: 'Spr', homozygous_genotype: 'Spr/Spr', heterozygous_genotypes: ['Spr/n'] ]] },
            { locus: 'Stm', category: 'marking', null_allele: 'n', genes: [{ allele: 'Stm', homozygous_genotype: 'Stm/Stm', heterozygous_genotypes: ['Stm/n'] ]] },
            { locus: 'Iri', category: 'marking', null_allele: 'n', genes: [{ allele: 'Iri', homozygous_genotype: 'Iri/Iri', heterozygous_genotypes: ['Iri/n'] ]] },
            { locus: 'Vit', category: 'mutation', null_allele: 'n', genes: [{ allele: 'Vit', homozygous_genotype: 'Vit/Vit', heterozygous_genotypes: ['Vit/n'] ]] },
            { locus: 'Inv', category: 'mutation', null_allele: 'n', genes: [{ allele: 'Inv', homozygous_genotype: 'Inv/Inv', heterozygous_genotypes: ['Inv/n'] ]] },
            { locus: 'Les', category: 'mutation', null_allele: 'n', genes: [{ allele: 'Les', homozygous_genotype: 'Les/Les', heterozygous_genotypes: ['Les/n'] ]] },
            { locus: 'Alb', category: 'mutation', null_allele: 'n', genes: [{ allele: 'Alb', homozygous_genotype: 'Alb/Alb', heterozygous_genotypes: ['Alb/n'] ]] },
            { locus: 'Axg', category: 'mutation', null_allele: 'n', genes: [{ allele: 'Axg', homozygous_genotype: 'Axg/Axg', heterozygous_genotypes: ['Axg/n'] ]] },
            { locus: 'Ery', category: 'mutation', null_allele: 'n', genes: [{ allele: 'Ery', homozygous_genotype: 'Ery/Ery', heterozygous_genotypes: ['Ery/n'] ]] },
            { locus: 'Lva', category: 'mutation', null_allele: 'n', genes: [{ allele: 'Lva', homozygous_genotype: 'Lva/Lva', heterozygous_genotypes: ['Lva/n'] ]] },
            { locus: 'Axm', category: 'mutation', null_allele: 'n', genes: [{ allele: 'Axm', homozygous_genotype: 'Axm/Axm', heterozygous_genotypes: ['Axm/n'] ]] },
            { locus: 'Cm', category: 'mutation', null_allele: 'n', genes: [{ allele: 'Cm', homozygous_genotype: 'Cm/Cm', heterozygous_genotypes: ['Cm/n'] ]] },
            { locus: 'Hr', category: 'trait', null_allele: 'n', genes: [{ allele: 'Hr', homozygous_genotype: 'Hr/Hr', heterozygous_genotypes: ['Hr/n'] ]] },
            { locus: 'Fg', category: 'trait', null_allele: 'n', genes: [{ allele: 'Fg', homozygous_genotype: 'Fg/Fg', heterozygous_genotypes: ['Fg/n'] ]] },
            { locus: 'St', category: 'trait', null_allele: 'n', genes: [{ allele: 'St', homozygous_genotype: 'St/St', heterozygous_genotypes: ['St/n'] ]] }
        ];

        // Helper Classes
        class GenotypeHelper {
            static sliceGenotype(genotype) {
                try {
                    if (!genotype || typeof genotype !== 'string') {
                        Logger.log(`${CONFIG.LOGGING.PREFIX} Invalid genotype input: ${genotype}`);
                        throw new Error(`Invalid genotype input: ${genotype}`);
                    }
                    const genes = genotype.split(' ').filter(g => g && g.trim() && /^[A-Za-z0-9+\/-]+$/.test(g));
                    if (!genes.length) {
                        Logger.log(`${CONFIG.LOGGING.PREFIX} No valid genes found in genotype: ${genotype}`);
                    }
                    return genes;
                } catch (e) {
                    ErrorHandler.handle(e, 'sliceGenotype');
                    return [];
                }
            }

            static getAlleles(genes, loci_data) {
                try {
                    if (!Array.isArray(genes) || !Array.isArray(loci_data)) {
                        throw new Error('Invalid input types');
                    }
                    
                    const alleles = {};
                    const validAlleles = loci_data.flatMap(l => l.genes.map(g => g.allele)).concat('n');
                    
                    for (const locus of loci_data) {
                        const geneOnLocus = genes.find(g => {
                            if (!g) return false;
                            const allelesInGene = g.includes('/') ? g.split('/') : [g];
                            return allelesInGene.some(a => locus.genes.some(lg => lg.allele === a));
                        });
                        
                        alleles[locus.locus] = geneOnLocus
                            ? geneOnLocus.includes('/')
                                ? geneOnLocus.split('/').map(a => validAlleles.includes(a) ? a : locus.null_allele).slice(0, 2)
                                : [validAlleles.includes(geneOnLocus) ? geneOnLocus : locus.null_allele, locus.null_allele]
                            : [locus.null_allele, locus.null_allele];
                            
                        if (alleles[locus.locus].length !== 2) {
                            Logger.log(`${CONFIG.LOGGING.PREFIX} Invalid allele pair for locus ${locus.locus}: ${alleles[locus.locus]}`);
                            alleles[locus.locus] = [locus.null_allele, locus.null_allele];
                        }
                    }
                    return alleles;
                } catch (e) {
                    ErrorHandler.handle(e, 'getAlleles');
                    throw new Error('Invalid genotype format: use valid alleles (e.g., B+/BA, K+/KB, Spt).');
                }
            }
        }

        class PhenotypeHelper {
            static phenotypeCache = new Map();

            static getPhenotype(genes, phenotypeData, mane) {
                try {
                    if (!Array.isArray(genes) || !Array.isArray(phenotypeData) || !mane || typeof mane !== 'string') {
                        Logger.log(`${CONFIG.LOGGING.PREFIX} Invalid input: genes=${JSON.stringify(genes)}, mane=${mane}`);
                        throw new Error(`Invalid input: genes=${JSON.stringify(genes)}, mane=${mane}`);
                    }

                    const cacheKey = `${genes.join('|')}|${mane}`;
                    if (this.phenotypeCache.has(cacheKey)) {
                        return this.phenotypeCache.get(cacheKey);
                    }

                    const has = (allele) => {
                        if (typeof allele !== 'string' || !allele.trim()) {
                            Logger.log(`${CONFIG.LOGGING.PREFIX} Invalid allele: ${allele}`);
                            return false;
                        }
                        return genes.some(g => {
                            if (typeof g !== 'string' || !g.trim()) {
                                Logger.log(`${CONFIG.LOGGING.PREFIX} Invalid gene: ${g}`);
                                return false;
                            }
                            return g === allele || g.includes(`/${allele}`) || g.includes(`${allele}/`);
                        });
                    };

                    let baseCoat = 'Tan';
                    if (has('R/R')) baseCoat = 'Vermillion';
                    else if (has('J/J')) baseCoat = 'Jade';
                    else if (has('C/C')) baseCoat = 'Amber';
                    else if (has('P/P')) baseCoat = 'Pearl';
                    else {
                        const bLocus = genes.find(g => g.includes('B+') || g.includes('BA') || g.includes('BG') || g.includes('BW'))?.split('/') || ['n', 'n'];
                        const mLocus = genes.find(g => g.includes('M+') || g.includes('MB') || g.includes('M0'))?.split('/') || ['n', 'n'];
                        const kLocus = genes.find(g => g.includes('K+') || g.includes('KB'))?.split('/') || ['K+', 'K+'];
                        
                        const bCombo = bLocus.sort().join('/');
                        const mCombo = mLocus.sort().join('/');
                        const kCombo = kLocus.sort().join('/');

                        for (const pheno of phenotypeData) {
                            if (pheno.TYPE === GeneType.BASE && pheno.EXPRESSED_SETS.some(set => 
                                set.length === 3 && set[0] === bCombo && set[1] === mCombo && set[2] === kCombo)) {
                                baseCoat = pheno.TEXT;
                                break;
                            }
                        }
                    }

                    let expressed = [];
                    const carried = [];
                    for (const pheno of phenotypeData) {
                        if (!pheno || typeof pheno !== 'object' || !pheno.TEXT || typeof pheno.TEXT !== 'string' || pheno.TYPE === undefined) {
                            Logger.log(`${CONFIG.LOGGING.PREFIX} Skipping invalid phenotype entry: ${JSON.stringify(pheno)}`);
                            continue;
                        }
                        if (pheno.TYPE !== GeneType.BASE && pheno.TYPE !== GeneType.MANE) {
                            if (Array.isArray(pheno.EXPRESSED_SETS)) {
                                const isValidExpressed = pheno.EXPRESSED_SETS.every(set => 
                                    Array.isArray(set) && set.length > 0 && set.every(gene => typeof gene === 'string' && gene.trim())
                                );
                                if (isValidExpressed) {
                                    if (pheno.EXPRESSED_SETS.some(set => set.every(gene => has(gene)))) {
                                        expressed.push(pheno.TEXT);
                                    }
                                } else {
                                    Logger.log(`${CONFIG.LOGGING.PREFIX} Invalid EXPRESSED_SETS in ${pheno.TEXT}: ${JSON.stringify(pheno.EXPRESSED_SETS)}`);
                                }
                            }
                            if (Array.isArray(pheno.CARRIED_SETS)) {
                                const isValidCarried = pheno.CARRIED_SETS.every(set => 
                                    Array.isArray(set) && set.length > 0 && set.every(gene => typeof gene === 'string' && gene.trim())
                                );
                                if (isValidCarried) {
                                    if (pheno.CARRIED_SETS.some(set => set.every(gene => has(gene)))) {
                                        carried.push(`Carries ${pheno.TEXT}`);
                                    }
                                } else {
                                    Logger.log(`${CONFIG.LOGGING.PREFIX} Invalid CARRIED_SETS in ${pheno.TEXT}: ${JSON.stringify(pheno.CARRIED_SETS)}`);
                                }
                            }
                        }
                    }

                    for (const rule of OverrideRules) {
                        if (rule.requires.every(req => has(req))) {
                            expressed = expressed.filter(p => !rule.removes.includes(p));
                            expressed.push(rule.result);
                        }
                    }

                    let phenoString = `${baseCoat} with ${mane} Mane`;
                    const markings = expressed.filter(p => {
                        const gene = GeneMap[p.toUpperCase()];
                        return gene && gene.TYPE === GeneType.MARKING;
                    });
                    if (markings.length) phenoString += ` / ${markings.join(' / ')}`;
                    const traits = expressed.filter(p => {
                        const gene = GeneMap[p.toUpperCase()];
                        return gene && gene.TYPE === GeneType.TRAIT;
                    });
                    if (traits.length) phenoString += ` [${traits.join(', ')}]`;
                    const mutations = expressed.filter(p => {
                        const gene = GeneMap[p.toUpperCase()];
                        return gene && gene.TYPE === GeneType.MUTATION;
                    });
                    if (mutations.length) phenoString += ` (${mutations.join(', ')})`;
                    if (carried.length) phenoString += ` (${carried.join(', ')})`;

                    this.phenotypeCache.set(cacheKey, phenoString);
                    return phenoString;
                } catch (e) {
                    ErrorHandler.handle(e, 'getPhenotype');
                    return 'Error calculating phenotype';
                }
            }
        }

        class PunnettHelper {
            static getPossibleClutchSize(p_a, p_b, items) {
                try {
                    const perkA = AgePerks[p_a.age] || AgePerks[Age.YOUNG_ADULT];
                    const perkB = AgePerks[p_b.age] || AgePerks[Age.YOUNG_ADULT];
                    let min = Math.min(perkA.clutch_min, perkB.clutch_min);
                    let max = Math.max(perkA.clutch_max, perkB.clutch_max) + 
                              (items.crescent_herb ? 2 : 0) + 
                              (items.moonlit_herb ? 2 : 0);
                    if (p_a.age === Age.CELESTIAL || p_b.age === Age.CELESTIAL) {
                        min = 2;
                        max = 2;
                    }
                    return min === max ? `${min} ${min === 1 ? 'egg' : 'eggs'}` : `${min} - ${max} eggs`;
                } catch (e) {
                    ErrorHandler.handle(e, 'getPossibleClutchSize');
                    return CONFIG.BREEDING.DEFAULT_CLUTCH;
                }
            }

            static getSexOdds() {
                try {
                    return { [Sex.MALE]: 50, [Sex.FEMALE]: 50 };
                } catch (e) {
                    ErrorHandler.handle(e, 'getSexOdds');
                    return { [Sex.MALE]: 50, [Sex.FEMALE]: 50 };
                }
            }

            static getBreedOdds(a, b, celestialPerk) {
                try {
                    let odds = BreedMix[`${a}_${b}`] || BreedMix[`${b}_${a}`] || (a === b ? { [a]: 100 } : { [a]: 50, [b]: 50 });
                    if (celestialPerk === 'Savage Boon' && (a === Breed.DEST || b === Breed.DEST)) {
                        odds = { ...odds, [Breed.DEST]: (odds[Breed.DEST] || 0) + 5 };
                        let total = Object.values(odds).reduce((sum, val) => sum + val, 0);
                        Object.keys(odds).forEach(key => odds[key] = (odds[key] / total) * 100);
                    }
                    return odds;
                } catch (e) {
                    ErrorHandler.handle(e, 'getBreedOdds');
                    return { [Breed.THIL]: 100 };
                }
            }

            static getPunnettOdds(allelesA, allelesB) {
                try {
                    const odds = {};
                    for (const locus of loci) {
                        const a1 = allelesA[locus.locus]?.[0] || locus.null_allele;
                        const a2 = allelesA[locus.locus]?.[1] || locus.null_allele;
                        const b1 = allelesB[locus.locus]?.[0] || locus.null_allele;
                        const b2 = allelesB[locus.locus]?.[1] || locus.null_allele;
                        const outcomes = [[a1, b1], [a1, b2], [a2, b1], [a2, b2]].map(pair => pair.sort().join('/'));
                        const locusOdds = {};
                        outcomes.forEach(outcome => { locusOdds[outcome] = (locusOdds[outcome] || 0) + 25; });
                        odds[locus.locus] = Object.entries(locusOdds);
                    }
                    return odds;
                } catch (e) {
                    ErrorHandler.handle(e, 'getPunnettOdds');
                    throw new Error('Error calculating genotype odds');
                }
            }
        }

        function getManeOdds(maneA, maneB, speciesA, speciesB, celestialPerk) {
            try {
                const manes = [GeneMap.NATURAL, GeneMap.RAZOR, GeneMap.CURLY, GeneMap.SPHINX, GeneMap.LONG, GeneMap.FIERY, GeneMap.BARBARY];
                const odds = {};
                const maneRules = {
                    'Natural_Natural': { 'Natural': 75, 'Razor': 20, 'Sphinx': 5 },
                    'Natural_Razor': { 'Natural': 55, 'Razor': 43, 'Sphinx': 2 },
                    'Natural_Long': { 'Natural': 50, 'Long': 45, 'Curly': 5 },
                    'Natural_Curly': { 'Natural': 40, 'Long': 45, 'Curly': 15 },
                    'Natural_Sphinx': { 'Natural': 40, 'Razor': 55, 'Sphinx': 5 },
                    'Natural_Fiery': { 'Natural': 60, 'Long': 10, 'Curly': 25, 'Fiery': 5 },
                    'Natural_Barbary': { 'Long': 40, 'Natural': 20, 'Curly': 10, 'Fiery': 25, 'Barbary': 5 },
                    'Razor_Razor': { 'Razor': 100 },
                    'Razor_Sphinx': { 'Razor': 50, 'Sphinx': 50 },
                    'Razor_Long': { 'Razor': 50, 'Long': 50 },
                    'Razor_Curly': { 'Razor': 50, 'Curly': 50 },
                    'Razor_Fiery': { 'Razor': 50, 'Fiery': 50 },
                    'Razor_Barbary': { 'Razor': 50, 'Barbary': 50 },
                    'Sphinx_Sphinx': { 'Sphinx': 100 },
                    'Sphinx_Long': { 'Sphinx': 50, 'Long': 50 },
                    'Sphinx_Curly': { 'Sphinx': 50, 'Curly': 50 },
                    'Sphinx_Fiery': { 'Sphinx': 50, 'Fiery': 50 },
                    'Sphinx_Barbary': { 'Sphinx': 50, 'Barbary': 50 },
                    'Long_Long': { 'Long': 100 },
                    'Long_Curly': { 'Long': 50, 'Curly': 50 },
                    'Long_Fiery': { 'Long': 50, 'Fiery': 50 },
                    'Long_Barbary': { 'Long': 50, 'Barbary': 50 },
                    'Curly_Curly': { 'Curly': 100 },
                    'Curly_Fiery': { 'Curly': 50, 'Fiery': 50 },
                    'Curly_Barbary': { 'Curly': 50, 'Barbary': 50 },
                    'Fiery_Fiery': { 'Fiery': 100 },
                    'Fiery_Barbary': { 'Fiery': 50, 'Barbary': 50 },
                    'Barbary_Barbary': { 'Barbary': 100 }
                };

                const key = `${maneA}_${maneB}` in maneRules ? `${maneA}_${maneB}` : `${maneB}_${maneA}`;
                const rule = maneRules[key] || (maneA === maneB ? { [maneA]: 100 } : { [maneA]: 50, [maneB]: 50 });

                manes.forEach(mane => {
                    odds[mane.TEXT] = rule[mane.TEXT] || 0;
                });

                if (celestialPerk === 'Divine Blessing') {
                    odds[GeneMap.FIERY.TEXT] = (odds[GeneMap.FIERY.TEXT] || 0) + 5;
                    odds[GeneMap.BARBARY.TEXT] = (odds[GeneMap.BARBARY.TEXT] || 0) + 5;
                    let total = Object.values(odds).reduce((sum, val) => sum + val, 0);
                    Object.keys(odds).forEach(key => odds[key] = (odds[key] / total) * 100);
                }

                let total = Object.values(odds).reduce((sum, val) => sum + val, 0);
                if (total === 0) {
                    odds['Natural'] = 100;
                } else {
                    Object.keys(odds).forEach(key => {
                        odds[key] = (odds[key] / total) * 100;
                    });
                }

                return odds;
            } catch (e) {
                ErrorHandler.handle(e, 'getManeOdds');
                return { [CONFIG.BREEDING.DEFAULT_MANE]: 100 };
            }
        }

        function getTraitOdds(items, parentA, parentB) {
            try {
                const odds = {};
                const traits = [GeneMap.HORNED, GeneMap.FANGED, GeneMap.SABRETEETH];
                const perkA = AgePerks[parentA.age] || AgePerks[Age.YOUNG_ADULT];
                const perkB = AgePerks[parentB.age] || AgePerks[Age.YOUNG_ADULT];
                const bonus = Math.max(perkA.trait_pass_bonus, perkB.trait_pass_bonus) + (items.moonlit_herb ? 10 : 0);
                
                traits.forEach(trait => {
                    const hasTrait = parentA.genotype.includes(trait.TEXT[0]) || parentB.genotype.includes(trait.TEXT[0]);
                    odds[trait.TEXT] = hasTrait ? 50 + bonus : 10 + bonus;
                });
                return odds;
            } catch (e) {
                ErrorHandler.handle(e, 'getTraitOdds');
                return { Horned: 10, Fanged: 10, Sabreteeth: 10 };
            }
        }

        function getElementOdds(elementA, elementB) {
            try {
                const odds = {};
                Object.values(Element).forEach(elem => {
                    odds[elem] = elem === elementA || elem === elementB ? 40 : 5;
                });
                return odds;
            } catch (e) {
                ErrorHandler.handle(e, 'getElementOdds');
                return { [CONFIG.BREEDING.DEFAULT_ELEMENT]: 100 };
            }
        }

        function calculateInfertility(parentA, parentB, coi) {
            try {
                const coiMap = { 'None': 0, 'Slight': 15, 'Medium': 30, 'High': 50 };
                let infertility = coiMap[coi] || 0;
                if (parentA.age === Age.ADOLESCENT || parentB.age === Age.ADOLESCENT) infertility += 20;
                return Math.min(infertility, 100);
            } catch (e) {
                ErrorHandler.handle(e, 'calculateInfertility');
                return 0;
            }
        }

        function calculateDefects(coi) {
            const coiMap = { 'None': 0, 'Slight': 1, 'Medium': 2, 'High': 3 };
            const coiLevel = coiMap[coi] || 0;
            const defectOdds = {
                Common: coiLevel * 10, // e.g., 30% for High COI
                Uncommon: coiLevel * 5, // e.g., 15% for High COI
                Rare: coiLevel * 2, // e.g., 6% for High COI
                VeryRare: coiLevel * 1 // e.g., 3% for High COI
            };
            const defects = [];
            Object.entries(defectOdds).forEach(([rarity, chance]) => {
                if (Math.random() * 100 < chance) {
                    const defect = Defects[rarity][Math.floor(Math.random() * Defects[rarity].length)];
                    if (!defects.includes(defect)) defects.push(defect);
                }
            });
            return defects;
        }

        function getPhenotypeForSidebar(genotype, mane) {
            try {
                if (!genotype || !mane) {
                    throw new Error('Missing genotype or mane');
                }
                
                GeneticsService.load();
                const genes = GenotypeHelper.sliceGenotype(genotype);
                if (!genes.length) {
                    throw new Error('Empty genotype array');
                }
                
                const phenotype = PhenotypeHelper.getPhenotype(genes, GeneticsService.phenotypes, mane);
                if (CONFIG.LOGGING.ENABLED) {
                    Logger.log(`${CONFIG.LOGGING.PREFIX} Phenotype calculated: ${phenotype}`);
                }
                return phenotype;
            } catch (e) {
                ErrorHandler.handle(e, 'getPhenotypeForSidebar');
                return 'Error calculating phenotype';
            }
        }

        function calculatePossibilities(p_a, p_b, items, coiString) {
            try {
                if (!AgePerks[p_a.age]?.breedable || !AgePerks[p_b.age]?.breedable) {
                    throw new Error('One or both parents are too young to breed.');
                }
                
                const pA_alleles = GenotypeHelper.getAlleles(GenotypeHelper.sliceGenotype(p_a.genotype), GeneticsService.loci);
                const pB_alleles = GenotypeHelper.getAlleles(GenotypeHelper.sliceGenotype(p_b.genotype), GeneticsService.loci);
                
                return {
                    infertility: calculateInfertility(p_a, p_b, coiString),
                    clutch: PunnettHelper.getPossibleClutchSize
