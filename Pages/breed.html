<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Breeding Roller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .container {
            max-width: 1600px;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .card-header {
            font-weight: bold;
            font-size: 1.25rem;
        }
        .chimera-section, .inbreed-details {
            display: none;
            border-left: 3px solid #0d6efd;
            padding-left: 1rem;
            margin-top: 1rem;
        }
        #resultsModal .modal-body {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .form-label {
            font-weight: 500;
        }
        hr {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        h2 {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .error-alert {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Dragon Breeding Roller üêâ</h2>

    <div class="alert alert-danger error-alert" id="error-container" role="alert"></div>

    <!-- Sire and Dam Forms -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">Sire</div>
                <div class="card-body" id="sire-form">
                    <!-- Sire form injected here -->
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-danger text-white">Dam</div>
                <div class="card-body" id="dam-form">
                    <!-- Dam form injected here -->
                </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Settings and Items -->
    <div class="card">
        <div class="card-header">Breeding Settings & Items</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h5>Inbreeding</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="inbred-check">
                        <label class="form-check-label" for="inbred-check">Are the Parents Inbred?</label>
                    </div>
                    <div class="mt-2 inbreed-details">
                        <label for="inbreedingLevel" class="form-label">Inbreeding Level:</label>
                        <select id="inbreedingLevel" class="form-select">
                            <option value="None">None</option>
                            <option value="Slight">Slight</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Severe">Severe</option>
                        </select>
                    </div>
                     <h5 class="mt-3">Bonding</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="bond-breeding-check">
                        <label class="form-check-label" for="bond-breeding-check">Bond Breeding</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <h5>Items</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="fertility-item" id="crescent-herb">
                        <label class="form-check-label" for="crescent-herb">Crescent Herb (Chance at +1 Hatchling)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="fertility-item" id="moonlit-herb">
                        <label class="form-check-label" for="moonlit-herb">Moonlit Herb (Increased mutations, up to +2 cubs)</label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" value="" id="calming-brow">
                        <label class="form-check-label" for="calming-brow">Calming Brow (Increased Destrier chance)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="questionable-potion">
                        <label class="form-check-label" for="questionable-potion">Questionable Potion (Chance for random manetype)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="hearty-meal">
                        <label class="form-check-label" for="hearty-meal">Hearty Meal (Healthier cubs for young/inbred parents)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="dubious-food">
                        <label class="form-check-label" for="dubious-food">Dubious Food (Chance for defects)</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <h5>Companions</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="red-panda-companion">
                        <label class="form-check-label" for="red-panda-companion">Red Panda (2% chance for base color modifiers)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="crane-companion">
                        <label class="form-check-label" for="crane-companion">Crane (2% chance increase of mutations)</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="text-center mt-4">
        <button id="randomize-all-btn" class="btn btn-secondary btn-lg me-2">Randomize Parents</button>
        <button id="roll-btn" class="btn btn-success btn-lg">Roll Breeding!</button>
    </div>

</div> 

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultsModalLabel">Breeding Results</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="results-output">
        <!-- Results will be printed here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- DATA DEFINITIONS ---
    const SPECIES = ['Cyroa', 'Thilyarem', 'Destrier'];
    const ACTIVE_SPECIES = SPECIES.filter(s => s !== 'Cyroa'); // Disable Cyroa for UI
    const AGES = ['Hatchling', 'Juvenile', 'Adolescent', 'Young Adult', 'Adult', 'Elder', 'Ancient', 'Celestial'];
    const GENOTYPES = {
        'Tan': ["B+/B+ M+/M+ K+/K+", "B+/B+ M+/MB K+/K+", "B+/B+ M+/M0 K+/K+", "B+/B+ MB/MB K+/K+", "B+/B+ MB/M0 K+/K+", "B+/B+ M+/M+ K+/KB", "B+/B+ M+/MB K+/KB", "B+/B+ M+/M0 K+/KB", "B+/B+ MB/MB K+/KB", "B+/B+ MB/M0 K+/KB", "B+/B+ M+/M+ KB/KB", "B+/B+ M+/MB KB/KB", "B+/B+ M+/M0 KB/KB", "B+/B+ MB/MB KB/KB", "B+/B+ MB/M0 KB/KB", "B+/BA M+/M+ K+/K+", "B+/BA M+/MB K+/K+", "B+/BA M+/M0 K+/K+", "B+/BA MB/MB K+/K+", "B+/BA MB/M0 K+/K+", "B+/BA M+/M+ K+/KB", "B+/BA M+/MB K+/KB", "B+/BA M+/M0 K+/KB", "B+/BA MB/MB K+/KB", "B+/BA MB/M0 K+/KB", "B+/BA M+/M+ KB/KB", "B+/BA M+/MB KB/KB", "B+/BA M+/M0 KB/KB", "B+/BA MB/MB KB/KB", "B+/BA MB/M0 KB/KB", "B+/BG M+/M+ K+/K+", "B+/BG M+/MB K+/K+", "B+/BG M+/M0 K+/K+", "B+/BG MB/MB K+/K+", "B+/BG MB/M0 K+/K+", "B+/BG M+/M+ K+/KB", "B+/BG M+/MB K+/KB", "B+/BG M+/M0 K+/KB", "B+/BG MB/MB K+/KB", "B+/BG MB/M0 K+/KB", "B+/BG M+/M+ KB/KB", "B+/BG M+/MB KB/KB", "B+/BG M+/M0 KB/KB", "B+/BG MB/MB KB/KB", "B+/BG MB/M0 KB/KB", "B+/BW M+/M+ K+/K+", "B+/BW M+/MB K+/K+", "B+/BW M+/M0 K+/K+", "B+/BW MB/MB K+/K+", "B+/BW MB/M0 K+/K+", "B+/BW M+/M+ K+/KB", "B+/BW M+/MB K+/KB", "B+/BW M+/M0 K+/KB", "B+/BW MB/MB K+/KB", "B+/BW MB/M0 K+/KB", "B+/BW M+/M+ KB/KB", "B+/BW M+/MB KB/KB", "B+/BW M+/M0 KB/KB", "B+/BW MB/MB KB/KB", "B+/BW MB/M0 KB/KB"],
        'Brown': ["BA/BA M+/M+ K+/K+", "BA/BA M+/MB K+/K+", "BA/BA M+/M0 K+/K+", "BA/BA MB/MB K+/K+", "BA/BA MB/M0 K+/K+", "BA/BA M+/M+ K+/KB", "BA/BA M+/MB K+/KB", "BA/BA M+/M0 K+/KB", "BA/BA MB/MB K+/KB", "BA/BA MB/M0 K+/KB", "BA/BA M+/M+ KB/KB", "BA/BA M+/MB KB/KB", "BA/BA M+/M0 KB/KB", "BA/BA MB/MB KB/KB", "BA/BA MB/M0 KB/KB", "BA/BG M+/M+ K+/K+", "BA/BG M+/MB K+/K+", "BA/BG M+/M0 K+/K+", "BA/BG MB/MB K+/K+", "BA/BG MB/M0 K+/K+", "BA/BG M+/M+ K+/KB", "BA/BG M+/MB K+/KB", "BA/BG M+/M0 K+/KB", "BA/BG MB/MB K+/KB", "BA/BG MB/M0 K+/KB", "BA/BG M+/M+ KB/KB", "BA/BG M+/MB KB/KB", "BA/BG M+/M0 KB/KB", "BA/BG MB/MB KB/KB", "BA/BG MB/M0 KB/KB", "BA/BW M+/M+ K+/K+", "BA/BW M+/MB K+/K+", "BA/BW M+/M0 K+/K+", "BA/BW MB/MB K+/K+", "BA/BW MB/M0 K+/K+", "BA/BW M+/M+ K+/KB", "BA/BW M+/MB K+/KB", "BA/BW M+/M0 K+/KB", "BA/BW MB/MB K+/KB", "BA/BW MB/M0 K+/KB", "BA/BW M+/M+ KB/KB", "BA/BW M+/MB KB/KB", "BA/BW M+/M0 KB/KB", "BA/BW MB/MB KB/KB", "BA/BW MB/M0 KB/KB"],
        'Green': ["BG/BG M+/M+ K+/K+", "BG/BG M+/MB K+/K+", "BG/BG M+/M0 K+/K+", "BG/BG MB/M0 K+/K+", "BG/BG M+/M+ K+/KB", "BG/BG M+/MB K+/KB", "BG/BG M+/M0 K+/KB", "BG/BG MB/M0 K+/KB", "BG/BG M+/M+ KB/KB", "BG/BG M+/MB KB/KB", "BG/BG M+/M0 KB/KB", "BG/BG MB/M0 KB/KB", "BG/BW M+/M+ K+/K+", "BG/BW M+/MB K+/K+", "BG/BW M+/M0 K+/K+", "BG/BW MB/M0 K+/K+", "BG/BW M+/M+ K+/KB", "BG/BW M+/MB K+/KB", "BG/BW M+/M0 K+/KB", "BG/BW MB/M0 K+/KB", "BG/BW M+/M+ KB/KB", "BG/BW M+/MB KB/KB", "BG/BW M+/M0 KB/KB", "BG/BW MB/M0 KB/KB"],
        'White': ["BW/BW M0/M0 K+/K+", "BW/BW M0/M0 K+/KB", "BW/BW M0/M0 KB/KB"],
        'Black': ["B+/B+ M+/M+ KB/KB", "B+/BA M+/M+ KB/KB", "B+/BG M+/M+ KB/KB", "B+/BW M+/M+ KB/KB", "BA/BA M+/M+ KB/KB", "BA/BG M+/M+ KB/KB", "BA/BW M+/M+ KB/KB", "BG/BG M+/M+ KB/KB", "BG/BW M+/M+ KB/KB", "BW/BW M+/M+ KB/KB"],
        'Cream': ["B+/B+ M0/M0 K+/K+", "B+/B+ M0/M0 K+/KB", "B+/B+ M0/M0 KB/KB", "B+/BA M0/M0 K+/K+", "B+/BA M0/M0 K+/KB", "B+/BA M0/M0 KB/KB", "B+/BG M0/M0 K+/K+", "B+/BG M0/M0 K+/KB", "B+/BG M0/M0 KB/KB", "B+/BW M0/M0 K+/K+", "B+/BW M0/M0 K+/KB", "B+/BW M0/M0 KB/KB"],
        'Lilac': ["BA/BA M0/M0 K+/K+", "BA/BA M0/M0 K+/KB", "BA/BA M0/M0 KB/KB", "BA/BG M0/M0 K+/K+", "BA/BG M0/M0 K+/KB", "BA/BG M0/M0 KB/KB", "BA/BW M0/M0 K+/K+", "BA/BW M0/M0 K+/KB", "BA/BW M0/M0 KB/KB"],
        'Seagreen': ["BG/BG MB/MB K+/K+", "BG/BG MB/MB K+/KB", "BG/BG MB/MB KB/KB", "BG/BW MB/MB K+/K+", "BG/BW MB/MB K+/KB", "BG/BW MB/MB KB/KB"],
        'Teagreen': ["BG/BG M0/M0 K+/K+", "BG/BG M0/M0 K+/KB", "BG/BG M0/M0 KB/KB", "BG/BW M0/M0 K+/K+", "BG/BW M0/M0 K+/KB", "BG/BW M0/M0 KB/KB"],
        'Slate': ["BW/BW M+/M+ K+/K+", "BW/BW M+/MB K+/K+", "BW/BW M+/M0 K+/K+", "BW/BW MB/M0 K+/K+", "BW/BW M+/M+ K+/KB", "BW/BW M+/MB K+/KB", "BW/BW M+/M0 K+/KB", "BW/BW MB/M0 K+/KB", "BW/BW M+/M+ KB/KB", "BW/BW M+/MB KB/KB", "BW/BW M+/M0 KB/KB", "BW/BW MB/M0 KB/KB"],
        'Blue': ["BW/BW MB/MB K+/K+", "BW/BW MB/MB K+/KB", "BW/BW MB/MB KB/KB"],
    };
    const MANETYPES = ['Natural', 'Razor', 'Sphinx', 'Curly', 'Long', 'Fiery', 'Barbary'];
    const ELEMENTS = ['Fire', 'Water', 'Air', 'Earth', 'Metal', 'Wood', 'Ice', 'Lightning', 'Light', 'Shadow', 'Aether', 'Verdant', 'Unknown'];
    const BASE_COLORS = Object.keys(GENOTYPES);

    const GENE_LIBRARY = {
        Markings: { Dpl: { name: 'Dapples', rarity: 'Common' }, Bt: { name: 'Bellytone', rarity: 'Common' }, Mtl: { name: 'Mantle', rarity: 'Common' }, Clr: { name: 'Collar', rarity: 'Common' }, Ikd: { name: 'Inked', rarity: 'Common' }, Sia: { name: 'Siamese', rarity: 'Common' }, Pnt: { name: 'Points', rarity: 'Common' }, Stn: { name: 'Stained', rarity: 'Common' }, Rn: { name: 'Roan', rarity: 'Common' }, Tby: { name: 'Tabby', rarity: 'Common' }, Spt: { name: 'Spotted', rarity: 'Common' }, Apl: { name: 'Appalosa', rarity: 'Uncommon' }, Mrl: { name: 'Merle', rarity: 'Uncommon' }, Brn: { name: 'Barring', rarity: 'Uncommon' }, Dn: { name: 'Dun', rarity: 'Uncommon' }, Pyn: { name: 'Python', rarity: 'Uncommon' }, Stk: { name: 'Streaks', rarity: 'Uncommon' }, Ovr: { name: 'Overo', rarity: 'Uncommon' }, Rsc: { name: 'Rorscach', rarity: 'Uncommon' }, Pg: { name: 'Pangare', rarity: 'Uncommon' }, Sb: { name: 'Sable', rarity: 'Uncommon' }, Pb: { name: 'Piebald', rarity: 'Rare' }, Gnt: { name: 'Glint', rarity: 'Rare' }, Sf: { name: 'Snowfall', rarity: 'Rare' }, Wd: { name: 'Widow', rarity: 'Rare' }, Dmd: { name: 'Diamond', rarity: 'Rare' }, Spr: { name: 'Spider', rarity: 'Rare' }, Stm: { name: 'Spectrum', rarity: 'Rare' }, Iri: { name: 'Iridescent', rarity: 'Rare' } },
        Mutations: { Vit: { name: 'Vitiligo', rarity: 'Common' }, Inv: { name: 'Inversa', rarity: 'Uncommon' }, Les: { name: 'Leucistic', rarity: 'Uncommon' }, Alb: { name: 'Albino', rarity: 'Uncommon' }, Axg: { name: 'Axanthic -G', rarity: 'Uncommon' }, Ery: { name: 'Erythristic', rarity: 'Rare' }, Lva: { name: 'Lavender Albino', rarity: 'Rare' }, Axm: { name: 'Axanthic-M', rarity: 'Rare' } },
        Traits: { Ho: { name: 'Horns', rarity: 'Uncommon' }, Fg: { name: 'Fangs', rarity: 'Uncommon' }, Sp: { name: 'Spines', rarity: 'Rare' } },
        Abilities: { Unbent: { name: 'Unbent'}, Cunning: { name: 'Cunning'}, Strike: { name: 'Strike'}, Bold: { name: 'Bold'}, Swift: { name: 'Swift'}, Skillful_Hunter: { name: 'Skillful Hunter'}, Completionist: { name: 'Completionist'}, Ocean_Champion: { name: 'Ocean Champion'}, Fish_Wrangler: { name: 'Fish Wrangler'}, Charismatic: { name: 'Charismatic'}, Shaman: { name: 'Shaman'}, Foraging_Maestro: { name: 'Foraging Maestro'} }
    };

    const DEFECTS = {
        'Slug Egg': { rarity: 'Uncommon', levels: { Slight: true, Moderate: true, Severe: true } },
        'Stillborn': { rarity: 'Very Rare', levels: { Slight: true, Moderate: true, Severe: true } },
        'Underdeveloped': { rarity: 'Very Rare', levels: { Slight: true, Moderate: true, Severe: true } },
        'Infertile': { rarity: 'Rare', levels: { Slight: true, Moderate: true, Severe: true } },
        'Deafness': { rarity: 'Common', levels: { Slight: false, Moderate: true, Severe: true } },
        'Blindness': { rarity: 'Common', levels: { Slight: false, Moderate: true, Severe: true } },
        'Anosmia': { rarity: 'Uncommon', levels: { Slight: false, Moderate: true, Severe: true } },
        'Malformed Tail': { rarity: 'Rare', levels: { Slight: false, Moderate: true, Severe: true } },
        'Malformed Limbs': { rarity: 'Rare', levels: { Slight: false, Moderate: true, Severe: true } },
        'Lameness': { rarity: 'Uncommon', levels: { Slight: false, Moderate: false, Severe: true } },
        'Hip Dysplasia': { rarity: 'Uncommon', levels: { Slight: false, Moderate: false, Severe: true } },
        'Heart Disease': { rarity: 'Rare', levels: { Slight: false, Moderate: false, Severe: true } },
        'Spinal Defect': { rarity: 'Very Rare', levels: { Slight: false, Moderate: false, Severe: true } },
        'Epilepsy': { rarity: 'Very Rare', levels: { Slight: false, Moderate: false, Severe: true } }
    };
    const RARITY_CHANCES = { 'Common': 0.15, 'Uncommon': 0.08, 'Rare': 0.04, 'Very Rare': 0.01 };

    const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const roll = (chance) => Math.random() < chance;

    function createParentForm(prefix) {
        const abilities = Object.values(GENE_LIBRARY.Abilities).map(t => t.name);
        return `
            <div class="mb-3"><label for="${prefix}-species" class="form-label">Species:</label><select id="${prefix}-species" class="form-select">${ACTIVE_SPECIES.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
            <div class="mb-3"><label for="${prefix}-age" class="form-label">Age:</label><select id="${prefix}-age" class="form-select">${AGES.map(a => `<option value="${a}">${a}</option>`).join('')}</select></div>
            <div class="mb-3"><label for="${prefix}-manetype" class="form-label">Manetype:</label><select id="${prefix}-manetype" class="form-select">${MANETYPES.map(m => `<option value="${m}">${m}</option>`).join('')}</select></div><hr>
            <h5>Genetics</h5>
            <div class="row">
                <div class="col-md-6 mb-3"><label for="${prefix}-base-color" class="form-label">Base Color (Phenotype):</label><select id="${prefix}-base-color" class="form-select base-color-selector" data-prefix="${prefix}">${BASE_COLORS.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
                <div class="col-md-6 mb-3"><label for="${prefix}-base-genetics" class="form-label">Base Genetics (Genotype):</label><select id="${prefix}-base-genetics" class="form-select"></select></div>
            </div>
            <div class="mb-3"><label for="${prefix}-marking-genetics" class="form-label">Marking Genetics:</label><textarea id="${prefix}-marking-genetics" class="form-control" rows="2" placeholder="e.g., Dpl/Dpl nSpt..."></textarea></div>
            <div class="mb-3"><label for="${prefix}-mutation-genetics" class="form-label">Mutation Genetics:</label><textarea id="${prefix}-mutation-genetics" class="form-control" rows="2" placeholder="e.g., nVit..."></textarea></div>
            <div class="mb-3"><label for="${prefix}-trait-genetics" class="form-label">Trait Genetics (Physical):</label><textarea id="${prefix}-trait-genetics" class="form-control" rows="2" placeholder="e.g., Ho/nHo Fg/Fg..."></textarea></div>
            <div class="form-check mb-3"><input class="form-check-input chimera-check" type="checkbox" id="${prefix}-chimera-check" data-prefix="${prefix}" disabled><label class="form-check-label" for="${prefix}-chimera-check">Chimerism (Handled by random roll)</label></div>
            <div class="chimera-section" id="${prefix}-chimera-section"></div><hr>
            <h5>Element & Abilities</h5>
            <div class="mb-3"><label for="${prefix}-element" class="form-label">Inborn Element:</label><select id="${prefix}-element" class="form-select">${ELEMENTS.slice(0,-1).map(e => `<option value="${e}">${e}</option>`).join('')}</select></div>
            <div class="mb-3"><label class="form-label">Abilities:</label><div class="row">${abilities.map(ability => `<div class="col-6 col-sm-4"><div class="form-check"><input class="form-check-input ability-checkbox" type="checkbox" value="${ability}" id="${prefix}-ability-${ability.replace(/ /g, '_')}"><label class="form-check-label" for="${prefix}-ability-${ability.replace(/ /g, '_')}">${ability}</label></div></div>`).join('')}</div></div>
            <div class="mb-3"><label class="form-label">Celestial Abilities:</label><div class="form-check"><input class="form-check-input" type="checkbox" id="${prefix}-divine-blessing"><label class="form-check-label" for="${prefix}-divine-blessing">Divine Blessing</label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="${prefix}-savage-boon"><label class="form-check-label" for="${prefix}-savage-boon">Savage Boon</label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="${prefix}-prismatic-aura"><label class="form-check-label" for="${prefix}-prismatic-aura">Prismatic Aura</label></div></div>`;
    }

    function updateBaseGenetics(prefix) { 
        const color = document.getElementById(`${prefix}-base-color`).value;
        const geneticsDropdown = document.getElementById(`${prefix}-base-genetics`);
        const options = GENOTYPES[color] || [];
        geneticsDropdown.innerHTML = options.map(g => `<option value="${g}">${g}</option>`).join('');
    }
    
    function parseAlleleString(str, library) { 
        const alleleMap = {};
        const parts = str.trim().split(/[\s,]+/);
        parts.forEach(part => {
            if (!part) return;
            let allele1, allele2, key;
            if (part.includes('/')) {
                [allele1, allele2] = part.split('/');
                key = allele1 === 'n' ? allele2.toUpperCase() : allele1.toUpperCase();
            } else if (part.startsWith('n')) {
                allele1 = 'n';
                allele2 = part.substring(1);
                key = allele2.toUpperCase();
            } else {
                 const match = part.match(/([A-Z][a-z]*)([A-Z][a-z]*)/i);
                 if (match && match[1].toUpperCase() === match[2].toUpperCase()) {
                     allele1 = allele2 = match[1];
                     key = allele1.toUpperCase();
                 } else { 
                     allele1 = allele2 = part;
                     key = part.toUpperCase();
                 }
            }
            // Find the correct key in the library, case-insensitively
            const libraryKey = Object.keys(library).find(k => k.toUpperCase() === key);
            if (libraryKey) {
                alleleMap[libraryKey] = [allele1, allele2].sort();
            }
        });
        return alleleMap;
    }

    function randomizeParent(prefix) { 
        // Select from active species
        document.getElementById(`${prefix}-species`).value = getRandom(ACTIVE_SPECIES);
        document.getElementById(`${prefix}-age`).value = getRandom(AGES.slice(2)); 
        document.getElementById(`${prefix}-manetype`).value = getRandom(MANETYPES);
        document.getElementById(`${prefix}-element`).value = getRandom(ELEMENTS.slice(0, -1));

        // Random base color and associated genotype
        const randomColor = getRandom(BASE_COLORS);
        document.getElementById(`${prefix}-base-color`).value = randomColor;
        updateBaseGenetics(prefix);
        const geneticsDropdown = document.getElementById(`${prefix}-base-genetics`);
        if (geneticsDropdown.options.length > 0) {
            geneticsDropdown.selectedIndex = Math.floor(Math.random() * geneticsDropdown.options.length);
        }

        // Generate random genes
        const markingKeys = Object.keys(GENE_LIBRARY.Markings);
        const mutationKeys = Object.keys(GENE_LIBRARY.Mutations);
        const traitKeys = Object.keys(GENE_LIBRARY.Traits);
        
        let markingsStr = "";
        const numMarkings = Math.floor(Math.random() * 5) + 2; // 2 to 6 markings
        for (let i = 0; i < numMarkings; i++) {
            const key = getRandom(markingKeys);
            markingsStr += roll(0.5) ? `${key}/${key} ` : `n${key} `;
        }

        let mutationsStr = "";
        const numMutations = Math.floor(Math.random() * 3); // 0 to 2 mutations
        for (let i = 0; i < numMutations; i++) {
            const key = getRandom(mutationKeys);
            mutationsStr += roll(0.5) ? `${key}/${key} ` : `n${key} `;
        }

        let traitsStr = "";
        const numTraits = Math.floor(Math.random() * 3); // 0 to 2 traits
        for (let i = 0; i < numTraits; i++) {
            const key = getRandom(traitKeys);
            traitsStr += roll(0.5) ? `${key}/${key} ` : `n${key} `;
        }
        
        document.getElementById(`${prefix}-marking-genetics`).value = markingsStr.trim();
        document.getElementById(`${prefix}-mutation-genetics`).value = mutationsStr.trim();
        document.getElementById(`${prefix}-trait-genetics`).value = traitsStr.trim();
        
        // Clear all ability checkboxes
        document.querySelectorAll(`#${prefix}-form .ability-checkbox`).forEach(cb => cb.checked = false);
    }
    
    function rollBreeding() {
        hideError();
        const sire = getParentData('sire');
        const dam = getParentData('dam');
        const settings = getSettings();
        
        if (['Hatchling', 'Juvenile'].includes(sire.age) || ['Hatchling', 'Juvenile'].includes(dam.age)) {
            showError('One or both dragons are too young to breed.');
            return;
        }
        if ((sire.species === 'Cyroa' && dam.species === 'Destrier') || (sire.species === 'Destrier' && dam.species === 'Cyroa')) {
            showError('Invalid Pairing: Destrier and Cyroa cannot breed together.');
            return;
        }

        let minCubs = 1, maxCubs = 5;
        if (sire.age === 'Adolescent' || dam.age === 'Adolescent') { minCubs = 0; maxCubs = 2; }
        else if (sire.age === 'Young Adult') { minCubs = 1; maxCubs = 3; }
        else if (sire.age === 'Elder') { minCubs = 2; maxCubs = 4; }
        else if (sire.age === 'Ancient') { minCubs = 2, maxCubs = 3; }
        else if (sire.age === 'Celestial') { minCubs = 2, maxCubs = 2; }
        
        let cubCount = Math.floor(Math.random() * (maxCubs - minCubs + 1)) + minCubs;
        if (settings.crescentHerb && roll(0.5)) cubCount++;
        if (settings.moonlitHerb) cubCount += Math.floor(Math.random() * 3);
        if (settings.bondBreeding) cubCount++;
        
        let output = cubCount === 0 ? "The breeding resulted in no viable hatchlings." : "";
        let viableHatchlings = 0;

        for (let i = 1; i <= cubCount; i++) {
            const cub = generateCub(sire, dam, settings);
            if (!cub.viable) {
                output += `================ HATCHLING #${i} ================\n`;
                output += `Status: ${cub.reason}\n\n`;
                continue;
            }
            viableHatchlings++;
            output += `================ HATCHLING #${viableHatchlings} ================\n`;
            if (cub.isChimera) output += `** Chimeric Markings/Mutations **\n`;
            output += `Species: ${cub.species.name}\nBuild: ${cub.species.build}\nSex: ${cub.sex}\nManetype: ${cub.manetype}\nElement: ${cub.element}\n`;
            output += `Base Color: ${cub.baseColor}\nGenotype: ${cub.genotype}\nPhenotype: ${cub.phenotype}\n`;
            output += `Mutations: ${cub.mutations}\nTraits: ${cub.traits}\nAbilities: ${cub.abilities.join(', ') || 'None'}\n`;
            output += `Fertility: ${cub.fertility}\nInbred: ${cub.inbred}\nDefects: ${cub.defects.length > 0 ? cub.defects.join(', ') : 'Healthy'}\n\n`;
        }
        showResults(output);
    }
    
    const inheritGeneCategory = (sire, dam, category) => {
        const inherited = [];
        const pheno = [];
        const lib = GENE_LIBRARY[category];
        const sireGenes = sire[category.toLowerCase()];
        const damGenes = dam[category.toLowerCase()];
        const allGeneKeys = [...new Set([...Object.keys(sireGenes), ...Object.keys(damGenes)])];
        
        allGeneKeys.forEach(key => {
            const sireAlleles = sireGenes[key] || ['n', 'n'];
            const damAlleles = damGenes[key] || ['n', 'n'];
            const sireHas = sireAlleles[1] !== 'n';
            const damHas = damAlleles[1] !== 'n';
            let passChance = 0;
            if (sireHas && damHas) passChance = 0.40;
            else if (sireHas || damHas) passChance = 0.15;
            
            if (roll(passChance)) {
                const childAlleles = [getRandom(sireAlleles), getRandom(damAlleles)].sort();
                if (childAlleles[1] !== 'n') {
                    inherited.push(childAlleles[0] === 'n' ? `n${key}` : `${key}/${key}`);
                    if (childAlleles.includes(key)) { pheno.push(lib[key].name); }
                }
            }
        });
        return { inherited, pheno };
    };

    function generateCub(sire, dam, settings) {
        const cub = { viable: true, isChimera: false };
        const defectsResult = determineDefects(sire, dam, settings);
        if (defectsResult.reason) return defectsResult;
        cub.defects = defectsResult.defects;
        cub.fertility = defectsResult.isInfertile ? "Infertile" : "Fertile";
        
        cub.sex = roll(0.5) ? 'Male' : 'Female';
        cub.species = determineSpecies(sire, dam, settings);
        cub.manetype = "Natural";
        cub.element = roll(0.5) ? sire.element : dam.element;
        cub.abilities = determineAbilities(sire, dam);
        cub.inbred = settings.isInbred ? 'Yes' : 'No';

        const baseAlleles = {};
        ['B', 'M', 'K'].forEach(locus => {
            const sireL = sire.baseGenetics.split(' ')['BMK'.indexOf(locus)].split('/');
            const damL = dam.baseGenetics.split(' ')['BMK'.indexOf(locus)].split('/');
            baseAlleles[locus] = [getRandom(sireL), getRandom(damL)].sort();
        });
        const baseGeno = `${baseAlleles.B.join('/')} ${baseAlleles.M.join('/')} ${baseAlleles.K.join('/')}`;
        cub.baseColor = determinePhenoColor(baseGeno);
        
        const primaryMarkings = inheritGeneCategory(sire, dam, 'Markings');
        const primaryMutations = inheritGeneCategory(sire, dam, 'Mutations');
        const primaryTraits = inheritGeneCategory(sire, dam, 'Traits');

        let otherGenes = [...primaryMarkings.inherited, ...primaryMutations.inherited, ...primaryTraits.inherited];
        cub.phenotype = primaryMarkings.pheno.join(', ') || 'None';
        cub.mutations = primaryMutations.pheno.join(', ') || 'None';
        cub.traits = primaryTraits.pheno.join(', ') || 'None';

        if (roll(0.01)) {
            cub.isChimera = true;
            cub.defects.push('Chimerism');
            const secondaryMarkings = inheritGeneCategory(sire, dam, 'Markings');
            const secondaryMutations = inheritGeneCategory(sire, dam, 'Mutations');
            cub.phenotype += ` // ${secondaryMarkings.pheno.join(', ') || 'None'}`;
            cub.mutations += ` // ${secondaryMutations.pheno.join(', ') || 'None'}`;
            otherGenes.push('//', ...secondaryMarkings.inherited, ...secondaryMutations.inherited);
        }

        let mutationChance = 0.015;
        if (settings.moonlitHerb) mutationChance += 0.10;
        if (settings.crane) mutationChance += 0.02;
        if (roll(mutationChance) && !cub.isChimera) {
            const randomMutationKey = getRandom(Object.keys(GENE_LIBRARY.Mutations));
            if (!otherGenes.some(m => m.includes(randomMutationKey))) {
                otherGenes.push(`n${randomMutationKey}`);
            }
        }
        
        const otherGenesString = otherGenes.join(' ');
        cub.genotype = baseGeno + (otherGenesString ? ` ${otherGenesString}` : '');
        
        return cub;
    }
    
    function determineDefects(sire, dam, settings) {
        const result = { defects: [], isInfertile: false };
        let riskModifier = 1.0;
        if (settings.heartyMeal) riskModifier *= 0.5;
        if (settings.dubiousFood) riskModifier *= 2.0;

        let baseRisk = 0;
        if (sire.age === 'Adolescent' || dam.age === 'Adolescent') baseRisk = 0.20;
        if (settings.isInbred) {
            if (settings.inbreedLevel === 'Slight') baseRisk += 0.10;
            else if (settings.inbreedLevel === 'Moderate') baseRisk += 0.25;
            else if (settings.inbreedLevel === 'Severe') baseRisk += 0.50;
        }
        if (settings.dubiousFood) baseRisk += 0.05;

        if (roll(baseRisk)) {
            for (const defect in DEFECTS) {
                const data = DEFECTS[defect];
                const isApplicable = !settings.isInbred || data.levels[settings.inbreedLevel];
                if (isApplicable) {
                    const chance = RARITY_CHANCES[data.rarity] * riskModifier;
                    if (roll(chance)) {
                         if (defect === 'Stillborn' || defect === 'Slug Egg') return { viable: false, reason: defect };
                         if (defect === 'Infertile') result.isInfertile = true;
                         result.defects.push(defect);
                    }
                }
            }
        }
        return result;
    }

    function determinePhenoColor(geno) { 
        for (const color in GENOTYPES) { if (GENOTYPES[color].includes(geno)) return color; } return "Unknown";
    }

    function determineSpecies(sire, dam, settings) { 
        const s = sire.species; const d = dam.species;
        
        // With Cyroa disabled, logic simplifies.
        // If both parents are Thilyarem, the result is Thilyarem.
        // If a Destrier is involved, the Destrier logic runs.
        let build = 'Thilyarem'; 
        
        if (s === 'Destrier' || d === 'Destrier') {
            let destrierChance = 0;
            if (s === 'Destrier' && d === 'Destrier') destrierChance = 0.40;
            else if (s === 'Destrier' || d === 'Destrier') destrierChance = 0.15;
            
            if (settings.calmingBrow) destrierChance += 0.1;
            if (sire.savageBoon || dam.savageBoon) destrierChance += 0.05;
            
            if (roll(destrierChance)) {
                build = 'Destrier';
            } else {
                build = 'Thilyarem';
            }
        }
        
        if (build === 'Destrier') return { name: 'Panlongus Lykophus Imperator', build: 'Destrier' };
        return { name: 'Panlongus lykophus pelagius', build: 'Thilyarem' };
    }
    
    function determineAbilities(sire, dam) { 
        const inheritedAbilities = [];
        Object.keys(GENE_LIBRARY.Abilities).forEach(key => {
            const abilityName = GENE_LIBRARY.Abilities[key].name;
            const sireHas = sire.abilities.includes(abilityName);
            const damHas = dam.abilities.includes(abilityName);
            let passChance = 0;
            if (sireHas && damHas) passChance = 0.40;
            else if (sireHas || damHas) passChance = 0.20;
            if(roll(passChance)) inheritedAbilities.push(abilityName);
        });
        return inheritedAbilities;
    }

    function getParentData(prefix) { 
        return {
            species: document.getElementById(`${prefix}-species`).value,
            age: document.getElementById(`${prefix}-age`).value,
            manetype: document.getElementById(`${prefix}-manetype`).value,
            element: document.getElementById(`${prefix}-element`).value,
            baseGenetics: document.getElementById(`${prefix}-base-genetics`).value,
            markings: parseAlleleString(document.getElementById(`${prefix}-marking-genetics`).value, GENE_LIBRARY.Markings),
            mutations: parseAlleleString(document.getElementById(`${prefix}-mutation-genetics`).value, GENE_LIBRARY.Mutations),
            traits: parseAlleleString(document.getElementById(`${prefix}-trait-genetics`).value, GENE_LIBRARY.Traits),
            abilities: Array.from(document.querySelectorAll(`#${prefix}-form .ability-checkbox:checked`)).map(cb => cb.value),
            savageBoon: document.getElementById(`${prefix}-savage-boon`).checked,
        };
    }

    function getSettings() { 
        return {
            isInbred: document.getElementById('inbred-check').checked,
            inbreedLevel: document.getElementById('inbreedingLevel').value,
            crescentHerb: document.getElementById('crescent-herb').checked,
            moonlitHerb: document.getElementById('moonlit-herb').checked,
            calmingBrow: document.getElementById('calming-brow').checked,
            dubiousFood: document.getElementById('dubious-food').checked,
            heartyMeal: document.getElementById('hearty-meal').checked,
            bondBreeding: document.getElementById('bond-breeding-check').checked,
            crane: document.getElementById('crane-companion').checked,
        };
    }

    function showError(message) { 
        const errorDiv = document.getElementById('error-container');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function hideError() { 
        document.getElementById('error-container').style.display = 'none';
    }
    
    function showResults(outputText) { 
        document.getElementById('results-output').textContent = outputText;
        const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
        resultsModal.show();
    }
    
    function init() {
        document.getElementById('sire-form').innerHTML = createParentForm('sire');
        document.getElementById('dam-form').innerHTML = createParentForm('dam');
        randomizeParent('sire');
        randomizeParent('dam');
        document.getElementById('roll-btn').addEventListener('click', rollBreeding);
        document.getElementById('randomize-all-btn').addEventListener('click', () => {
            randomizeParent('sire');
            randomizeParent('dam');
        });
        document.querySelectorAll('.base-color-selector').forEach(sel => {
            sel.addEventListener('change', (e) => updateBaseGenetics(e.target.dataset.prefix));
            updateBaseGenetics(sel.dataset.prefix);
        });
        document.getElementById('inbred-check').addEventListener('change', (e) => {
            document.querySelector('.inbreed-details').style.display = e.target.checked ? 'block' : 'none';
        });
    }

    init();
});
</script>

</body>
</html>
