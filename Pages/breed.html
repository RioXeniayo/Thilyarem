<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 1rem; }
        .form-label { font-weight: 600; }
        #results { margin-top: 1rem; padding: 1rem; border: 1px solid #dee2e6; border-radius: .375rem; min-height: 100px; }
        #loading { display: none; }
        .celestial-perk-section { display: none; } /* Hidden by default */
    </style>
  </head>
  <body>
    <div class="row">
      <!-- Sire Column -->
      <div class="col-md-6">
        <h4>Sire</h4>
        <div class="mb-3">
            <label for="sire_breed" class="form-label">Breed</label>
            <select id="sire_breed" class="form-select">
                <option>Thilyarem</option>
                <option>Destrier</option>
                <option>Cyroas</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="sire_age" class="form-label">Age</label>
            <select id="sire_age" class="form-select" onchange="checkCelestial()">
                <option>Hatchling</option>
                <option>Juvenile</option>
                <option>Adolescent</option>
                <option selected>Young Adult</option>
                <option>Adult</option>
                <option>Elder</option>
                <option>Ancient</option>
                <option>Celestial</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="sire_mane" class="form-label">Mane</label>
            <select id="sire_mane" class="form-select" onchange="updatePhenotype('sire')">
                <option>Natural</option>
                <option>Curly</option>
                <option>Sphinx</option>
                <option>Long</option>
                <option>Fiery</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="sire_element" class="form-label">Inborn Element</label>
            <select id="sire_element" class="form-select">
                <option>Fire</option><option>Water</option><option>Air</option><option>Earth</option>
                <option>Metal</option><option>Wood</option><option>Ice</option><option>Lightning</option>
                <option>Light</option><option>Shadow</option><option>Aether</option><option>Verdant</option>
            </select>
        </div>
         <div class="mb-3">
            <label for="sire_geno" class="form-label">Genotype</label>
            <input type="text" id="sire_geno" class="form-control" value="B+/BA M+/M0 K+/K+ Vm" oninput="updatePhenotype('sire')">
        </div>
        <div>
            <label for="sire_pheno" class="form-label">Phenotype</label>
            <input type="text" id="sire_pheno" class="form-control" readonly>
        </div>
      </div>

      <!-- Dam Column -->
      <div class="col-md-6">
        <h4 class="mt-4 mt-md-0">Dam</h4>
        <div class="mb-3">
            <label for="dam_breed" class="form-label">Breed</label>
            <select id="dam_breed" class="form-select">
                <option>Thilyarem</option>
                <option selected>Destrier</option>
                <option>Cyroas</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="dam_age" class="form-label">Age</label>
            <select id="dam_age" class="form-select" onchange="checkCelestial()">
                <option>Hatchling</option>
                <option>Juvenile</option>
                <option>Adolescent</option>
                <option selected>Young Adult</option>
                <option>Adult</option>
                <option>Elder</option>
                <option>Ancient</option>
                <option>Celestial</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="dam_mane" class="form-label">Mane</label>
            <select id="dam_mane" class="form-select" onchange="updatePhenotype('dam')">
                <option>Natural</option>
                <option>Curly</option>
                <option>Sphinx</option>
                <option>Long</option>
                <option>Fiery</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="dam_element" class="form-label">Inborn Element</label>
            <select id="dam_element" class="form-select">
                <option>Fire</option><option>Water</option><option>Air</option><option>Earth</option>
                <option>Metal</option><option>Wood</option><option>Ice</option><option>Lightning</option>
                <option>Light</option><option>Shadow</option><option>Aether</option><option>Verdant</option>
            </select>
        </div>
         <div class="mb-3">
            <label for="dam_geno" class="form-label">Genotype</label>
            <input type="text" id="dam_geno" class="form-control" value="BA/BA MB/M0 K+/KB" oninput="updatePhenotype('dam')">
        </div>
        <div>
            <label for="dam_pheno" class="form-label">Phenotype</label>
            <input type="text" id="dam_pheno" class="form-control" readonly>
        </div>
      </div>
    </div>
    
    <hr class="my-4">
    <h4>Items & Inbreeding</h4>
    <div class="row">
        <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="crescent_herb">
              <label class="form-check-label" for="crescent_herb">Crescent Herb (+2 pups max)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="moonlit_herb">
              <label class="form-check-label" for="moonlit_herb">Moonlit Herb (+mutations/traits, +2 pups max)</label>
            </div>
        </div>
        <div class="col-md-6">
            <label for="coi" class="form-label">Inbreeding Level</label>
            <select id="coi" class="form-select">
                <option>None</option>
                <option>Slight</option>
                <option>Medium</option>
                <option>High</option>
            </select>
        </div>
    </div>

    <!-- Celestial Perk Section -->
    <div id="celestialPerkSection" class="mt-4 celestial-perk-section">
        <hr>
        <h4>Celestial Perk</h4>
        <p><small>One parent is Celestial. Please choose ONE hereditary trait.</small></p>
        <select id="celestial_perk" class="form-select">
            <option>None</option>
            <option>Divine Blessing</option>
            <option>Savage Boon</option>
            <option>Prismatic Aura</option>
        </select>
    </div>

    <!-- Button Row -->
    <div class="d-flex justify-content-end mt-4">
        <button id="resetButton" class="btn btn-secondary me-2">Reset</button>
        <button id="rollButton" class="btn btn-primary">Hatch Time!</button>
    </div>
    
    <hr class="my-4">

    <!-- Results Section -->
    <h4>Results</h4>
    <div id="loading" style="display: none;">Calculating...</div>
    <div id="resultsWrapper" style="display: none;">
        <div id="results" class="space-y-4"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("rollButton").addEventListener("click", runBreeding);
        document.getElementById("resetButton").addEventListener("click", resetForm);
        
        updatePhenotype('sire');
        updatePhenotype('dam');
        checkCelestial();
      });

      function resetForm() {
        document.getElementById("sire_breed").value = 'Thilyarem';
        document.getElementById("sire_age").value = 'Young Adult';
        document.getElementById("sire_mane").value = 'Natural';
        document.getElementById("sire_element").value = 'Fire';
        document.getElementById("sire_geno").value = 'B+/BA M+/M0 K+/K+ Vm';
        document.getElementById("dam_breed").value = 'Destrier';
        document.getElementById("dam_age").value = 'Young Adult';
        document.getElementById("dam_mane").value = 'Natural';
        document.getElementById("dam_element").value = 'Fire';
        document.getElementById("dam_geno").value = 'BA/BA MB/M0 K+/KB';
        document.getElementById("crescent_herb").checked = false;
        document.getElementById("moonlit_herb").checked = false;
        document.getElementById("coi").value = 'None';
        document.getElementById("celestial_perk").value = 'None';
        updatePhenotype('sire');
        updatePhenotype('dam');
        checkCelestial();
        document.getElementById("results").innerHTML = 'Enter parent data and click "Hatch Time!" to see results.';
        document.getElementById("resultsWrapper").style.display = "none";
      }
      function checkCelestial() {
        const sireAge = document.getElementById("sire_age").value;
        const damAge = document.getElementById("dam_age").value;
        const perkSection = document.getElementById("celestialPerkSection");
        if (sireAge === 'Celestial' || damAge === 'Celestial') {
          perkSection.style.display = 'block';
        } else {
          perkSection.style.display = 'none';
        }
      }

      function updatePhenotype(parentPrefix) {
        const genoInput = document.getElementById(parentPrefix + "_geno");
        const maneInput = document.getElementById(parentPrefix + "_mane");
        const phenoInput = document.getElementById(parentPrefix + "_pheno");
        
        google.script.run
          .withSuccessHandler((phenotype) => {
            phenoInput.value = phenotype;
          })
          .getPhenotypeForSidebar(genoInput.value, maneInput.value);
      }

      function runBreeding() {
        document.getElementById("loading").style.display = "block";
        document.getElementById("results").innerHTML = "";
        document.getElementById("resultsWrapper").style.display = "none";

        const parentA = {
          species: document.getElementById("sire_breed").value,
          age: document.getElementById("sire_age").value,
          mane: document.getElementById("sire_mane").value,
          element: document.getElementById("sire_element").value,
          genotype: document.getElementById("sire_geno").value,
        };
        const parentB = {
          species: document.getElementById("dam_breed").value,
          age: document.getElementById("dam_age").value,
          mane: document.getElementById("dam_mane").value,
          element: document.getElementById("dam_element").value,
          genotype: document.getElementById("dam_geno").value,
        };
        const items = {
          crescent_herb: document.getElementById("crescent_herb").checked,
          moonlit_herb: document.getElementById("moonlit_herb").checked,
          celestial_perk: document.getElementById("celestial_perk").value,
        };
        const coi = document.getElementById("coi").value;

        google.script.run
          .withSuccessHandler(updateSidebar)
          .withFailureHandler(showError)
          .runBreedingCalculations(parentA, parentB, items, coi);
      }

      function updateSidebar(response) {
        document.getElementById("loading").style.display = "none";
        if (response.error) {
          showError({ message: response.error });
        } else {
          document.getElementById("results").innerHTML = response.resultsHtml;
          document.getElementById("resultsWrapper").style.display = "block";
        }
      }

      function showError(error) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("results").innerHTML = '<div class="alert alert-danger">' + error.message + '</div>';
        document.getElementById("resultsWrapper").style.display = "block";
      }
    </script>
  </body>
</html>
